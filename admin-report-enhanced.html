<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ¬∑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    * { box-sizing: border-box }
    body { font-family: 'Sarabun', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Sarabun', sans-serif; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <!-- ========== Login Screen ========== -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white shadow-xl rounded-2xl p-6">
      <div class="text-center mb-6">
        <div class="text-4xl">üîí</div>
        <h1 class="text-2xl font-bold text-gray-800 mt-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h1>
        <p class="text-gray-500 text-sm">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå <span class="font-semibold">admin / staff</span></p>
      </div>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
          <input id="loginUsername" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="staff@yourcenter.com" required/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input id="loginPassword" type="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required/>
        </div>
        <button class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
      <p id="loginError" class="hidden mt-4 text-sm text-red-600 text-center"></p>
      <div class="mt-4 text-xs text-gray-500 text-center">
        ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô Firebase Console ‚Üí Authentication ‚Üí Users
      </div>
    </div>
  </div>

  <!-- ========== Topbar ========== -->
  <header id="topbar" class="hidden bg-white/80 backdrop-blur sticky top-0 z-40 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üìä</span>
        <h1 class="text-lg md:text-xl font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Admin)</h1>
      </div>
      <div class="flex items-center gap-3">
        <span id="roleBadge" class="text-xs bg-amber-50 text-amber-700 border border-amber-200 rounded-full px-3 py-1">Role: -</span>
        <span id="currentUserBadge" class="text-xs bg-blue-50 text-blue-700 border border-blue-200 rounded-full px-3 py-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: -</span>
        <button id="logoutBtn" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </header>

  <!-- ========== App Main ========== -->
  <main id="app" class="hidden">
    <div class="max-w-7xl mx-auto px-4 py-6">

      <!-- Filters -->
      <section class="bg-white rounded-xl shadow p-4 md:p-6 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-end gap-3">
          <div>
            <label class="text-sm text-slate-600">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="fromDate" type="date" class="block border rounded-lg px-3 py-2 min-w-[200px]">
          </div>
          <div>
            <label class="text-sm text-slate-600">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="toDate" type="date" class="block border rounded-lg px-3 py-2 min-w-[200px]">
          </div>
          <div class="flex-1"></div>
          <div class="flex flex-wrap gap-2">
            <button id="btnApply" class="bg-blue-600 text-white px-4 py-2 rounded-lg">‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ</button>
            <button id="btnCSV" class="bg-emerald-600 text-white px-4 py-2 rounded-lg">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
            <button id="btnXLSX" class="bg-teal-600 text-white px-4 py-2 rounded-lg">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
          </div>
        </div>
      </section>

      <!-- Dynamic Report One-Chart -->
      <section class="bg-white rounded-xl shadow p-4 md:p-6 mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h2 class="text-xl font-semibold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</h2>
          <div class="flex flex-wrap items-center gap-3">
            <select id="reportTopic" class="border rounded-lg px-3 py-2">
              <option value="leads_time">Leads ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏™‡πâ‡∏ô)</option>
              <option value="status_bar">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏ó‡πà‡∏á)</option>
              <option value="room_bar">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á (‡πÅ‡∏ó‡πà‡∏á)</option>
              <option value="avg_price_group">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡πÄ‡∏û‡∏®/‡∏´‡πâ‡∏≠‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
              <option value="avg_age_group">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡πÄ‡∏û‡∏®/‡∏´‡πâ‡∏≠‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
              <option value="rev_month_room">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (stacked ‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á)</option>
              <option value="cust_month_status">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (stacked ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</option>
              <option value="funnel">Funnel (‡∏Å‡∏£‡∏ß‡∏¢)</option>
            </select>

            <select id="groupBy" class="border rounded-lg px-3 py-2">
              <option value="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
              <option value="gender">‡πÄ‡∏û‡∏®</option>
              <option value="roomType">‡∏´‡πâ‡∏≠‡∏á</option>
              <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
            </select>
          </div>
        </div>

        <div class="mt-4">
          <canvas id="dynamicChart" height="120"></canvas>
        </div>
        <p id="chartNote" class="text-xs text-gray-500 mt-3"></p>
      </section>

      <!-- Raw Table (peek) -->
      <section class="bg-white rounded-xl shadow p-4 md:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h2>
          <div class="text-sm text-gray-500">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="countFiltered">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="px-3 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
                <th class="px-3 py-2 text-left">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                <th class="px-3 py-2 text-left">‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏</th>
                <th class="px-3 py-2 text-left">‡∏´‡πâ‡∏≠‡∏á</th>
                <th class="px-3 py-2 text-left">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                <th class="px-3 py-2 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="divide-y"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <!-- ========== Scripts ========== -->
  <script type="module">
    /********** Imports **********/
    import { firebaseConfig } from "./firebaseConfig.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
    // Funnel (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á ‡πÜ)
    import "https://cdn.jsdelivr.net/npm/chartjs-chart-funnel@4";

    /********** Init **********/
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const colRef = collection(db, 'customers');

    /********** UI refs **********/
    const $ = (id) => document.getElementById(id);
    const loginScreen = $('loginScreen');
    const loginForm   = $('loginForm');
    const topbar      = $('topbar');
    const appMain     = $('app');
    const roleBadge   = $('roleBadge');
    const userBadge   = $('currentUserBadge');

    /********** State **********/
    let currentItems = [];      // snapshot ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    let filteredItems = [];     // ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    let unsubscribe = null;
    const STATUS_ORDER = [
      '‡πÉ‡∏´‡∏°‡πà','‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ','‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà',
      '‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à','‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à','‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå','‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'
    ];

    /********** Helpers **********/
    const fmtDate = (iso) => {
      const d = new Date(iso);
      return isNaN(d) ? '-' : d.toLocaleDateString('th-TH', {year:'numeric', month:'short', day:'numeric'});
    };
    const fmtMonth = (iso) => {
      const d = new Date(iso);
      return isNaN(d) ? '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    };
    const inRange = (dateISO, fromISO, toISO) => {
      if (!dateISO) return false;
      const t = new Date(dateISO).getTime();
      if (isNaN(t)) return false;
      const f = fromISO ? new Date(fromISO).getTime() : -Infinity;
      const to= toISO   ? new Date(toISO).getTime()   :  Infinity;
      return t >= f && t <= (to + 24*3600*1000 - 1);
    };
    const numberTH = (n) => new Intl.NumberFormat('th-TH').format(n||0);

    function setDefaultRange() {
      const to = new Date();
      const from = new Date(); from.setDate(from.getDate() - 89);
      $('toDate').valueAsDate = to;
      $('fromDate').valueAsDate = from;
    }

    /********** Auth **********/
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('loginUsername').value.trim();
      const pass  = $('loginPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        const box = $('loginError');
        box.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err?.code || err?.message || 'unknown');
        box.classList.remove('hidden');
      }
    });

    $('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        if (unsubscribe) unsubscribe();
        loginScreen.classList.remove('hidden');
        topbar.classList.add('hidden');
        appMain.classList.add('hidden');
        return;
      }
      // refresh token -> read claims
      await user.getIdToken(true);
      const token = await user.getIdTokenResult();
      const role  = token.claims?.role;
      userBadge.textContent = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + (user.email || user.uid);
      roleBadge.textContent = 'Role: ' + (role || '-');

      if (!['admin','staff'].includes(role)) {
        alert('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô');
        await signOut(auth);
        return;
      }

      // show app
      loginScreen.classList.add('hidden');
      topbar.classList.remove('hidden');
      appMain.classList.remove('hidden');

      // subscribe data realtime
      if (unsubscribe) unsubscribe();
      const q = query(colRef, orderBy('createdAt', 'desc'));
      unsubscribe = onSnapshot(q, (snap) => {
        currentItems = [];
        snap.forEach(d => currentItems.push({ id: d.id, ...d.data() }));
        applyFiltersAndRender(); // refresh table/chart
      });
    });

    /********** Table **********/
    function renderTable(items) {
      $('countFiltered').textContent = numberTH(items.length);
      const rows = items.map((c,i)=>`
        <tr class="hover:bg-slate-50">
          <td class="px-3 py-2">${i+1}</td>
          <td class="px-3 py-2">${fmtDate(c.date)}</td>
          <td class="px-3 py-2">${c.name||'-'}</td>
          <td class="px-3 py-2">${c.phone||'-'}</td>
          <td class="px-3 py-2">${(c.gender||'-')} / ${c.age||'-'} ‡∏õ‡∏µ</td>
          <td class="px-3 py-2">${c.roomType||'-'}</td>
          <td class="px-3 py-2">‡∏ø${numberTH(c.price||0)}</td>
          <td class="px-3 py-2">${c.decision||'-'}</td>
        </tr>
      `).join('');
      $('tableBody').innerHTML = rows || `<tr><td colspan="8" class="px-3 py-6 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    /********** Aggregations (for chart) **********/
    function countByMonth(items) {
      const map = {};
      items.forEach(c => { const m = fmtMonth(c.date); map[m]=(map[m]||0)+1; });
      const labels = Object.keys(map).sort();
      return { labels, data: labels.map(l => map[l]) };
    }
    function countByField(items, field, orderLabels) {
      const m = {};
      items.forEach(c => { const k = c[field] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; m[k]=(m[k]||0)+1; });
      let labels = Object.keys(m);
      if (orderLabels) labels = orderLabels.filter(k => k in m).concat(labels.filter(k=>!orderLabels.includes(k)));
      return { labels, data: labels.map(l => m[l] || 0) };
    }
    function avgByField(items, field, valueField) {
      const sum = {}, cnt = {};
      items.forEach(c => {
        const k = (field==='month') ? fmtMonth(c.date) : (c[field] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
        const v = Number(c[valueField] || 0); if (!Number.isFinite(v)) return;
        sum[k]=(sum[k]||0)+v; cnt[k]=(cnt[k]||0)+1;
      });
      const labels = Object.keys(sum).sort();
      const data = labels.map(l => sum[l]/(cnt[l]||1));
      return { labels, data };
    }
    function stackedMonthByField(items, stackField, valueMode='count') {
      const months = new Set(), cats = new Set(), map = {};
      items.forEach(c => {
        const m = fmtMonth(c.date);
        const cat = c[stackField] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        months.add(m); cats.add(cat);
        map[cat] = map[cat] || {};
        map[cat][m] = (map[cat][m]||0) + (valueMode==='sumPrice' ? Number(c.price||0) : 1);
      });
      const labels = Array.from(months).sort();
      const categories = Array.from(cats);
      const datasets = categories.map(cat => ({ label: cat, data: labels.map(m=>map[cat]?.[m]||0), stack:'s1' }));
      return { labels, datasets };
    }

    /********** Chart (dynamic) **********/
    let chart;
    function renderChart(cfg) {
      const ctx = $('dynamicChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, cfg);
    }
    function labelOf(groupBy) {
      return ({ status:'‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', gender:'‡πÄ‡∏û‡∏®', roomType:'‡∏´‡πâ‡∏≠‡∏á', month:'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' }[groupBy] || groupBy);
    }
    function updateChart(items) {
      const topic  = $('reportTopic').value;
      const groupBy= $('groupBy').value;

      if (!items.length) {
        renderChart({ type:'bar', data:{ labels:['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'], datasets:[{label:'', data:[0]}] } });
        $('chartNote').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
        return;
      }

      let cfg, note='';

      switch(topic) {
        case 'leads_time': {
          const { labels, data } = countByMonth(items);
          cfg = { type:'line', data:{ labels, datasets:[{label:'Leads', data, tension:.3}] }, options:{responsive:true} };
          note = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Leads ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
          break;
        }
        case 'status_bar': {
          const { labels, data } = countByField(items, 'decision', STATUS_ORDER);
          cfg = { type:'bar', data:{ labels, datasets:[{label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data}] }, options:{responsive:true} };
          note = '‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
          break;
        }
        case 'room_bar': {
          const { labels, data } = countByField(items, 'roomType');
          cfg = { type:'bar', data:{ labels, datasets:[{label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data}] }, options:{responsive:true} };
          note = '‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á';
          break;
        }
        case 'avg_price_group': {
          const field = (groupBy==='month') ? 'month' : groupBy;
          const { labels, data } = avgByField(items, field, 'price');
          cfg = { type:'bar', data:{ labels, datasets:[{label:'‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ö‡∏≤‡∏ó)', data}] }, options:{responsive:true} };
          note = `‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° ${labelOf(groupBy)}`;
          break;
        }
        case 'avg_age_group': {
          const field = (groupBy==='month') ? 'month' : groupBy;
          const { labels, data } = avgByField(items, field, 'age');
          cfg = { type:'bar', data:{ labels, datasets:[{label:'‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏õ‡∏µ)', data}] }, options:{responsive:true} };
          note = `‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° ${labelOf(groupBy)}`;
          break;
        }
        case 'rev_month_room': {
          const { labels, datasets } = stackedMonthByField(items, 'roomType', 'sumPrice');
          cfg = { type:'bar', data:{ labels, datasets }, options:{responsive:true, scales:{x:{stacked:true}, y:{stacked:true}}} };
          note = '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á (Stacked)';
          break;
        }
        case 'cust_month_status': {
          const { labels, datasets } = stackedMonthByField(items, 'decision', 'count');
          cfg = { type:'bar', data:{ labels, datasets }, options:{responsive:true, scales:{x:{stacked:true}, y:{stacked:true}}} };
          note = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Stacked)';
          break;
        }
        case 'funnel': {
          const { labels, data } = countByField(items, 'decision', STATUS_ORDER);
          const hasFunnel = !!Chart.registry?.controllers?.funnel;
          if (hasFunnel) {
            cfg = { type:'funnel', data:{ labels, datasets:[{ label:'Funnel', data }] }, options:{ responsive:true } };
          } else {
            cfg = { type:'bar', data:{ labels, datasets:[{ label:'Funnel (bar)', data }] }, options:{ indexAxis:'y', responsive:true } };
            note = 'TIP: ‡πÇ‡∏´‡∏•‡∏î chartjs-chart-funnel ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏Å‡∏£‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á';
          }
          note = (note||'') + ' ‚Ä¢ ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
          break;
        }
      }
      renderChart(cfg);
      $('chartNote').textContent = note;
    }

    /********** Filter + Render orchestration **********/
    function applyFiltersAndRender() {
      const fromISO = $('fromDate').value;
      const toISO   = $('toDate').value;
      filteredItems = (currentItems || []).filter(c => inRange(c.date, fromISO, toISO));
      renderTable(filteredItems);
      updateChart(filteredItems);
    }

    /********** Export **********/
    function download(filename, blob) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }
    function toCSV(items) {
      const headers = ['date','name','phone','gender','age','roomType','price','decision','disease','specialCare','id'];
      const lines = [headers.join(',')];
      items.forEach(c=>{
        const row = headers.map(h=>{
          let v = (c[h] ?? '');
          if (typeof v === 'string') {
            v = v.replace(/"/g,'""');
            return `"${v}"`;
          }
          return v;
        });
        lines.push(row.join(','));
      });
      // add BOM ‡πÉ‡∏´‡πâ Excel ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      return new Blob([new Uint8Array([0xEF,0xBB,0xBF]), lines.join('\n')], { type:'text/csv;charset=utf-8' });
    }

    $('btnCSV').addEventListener('click', () => {
      const blob = toCSV(filteredItems);
      download(`customers-${new Date().toISOString().slice(0,10)}.csv`, blob);
    });
    $('btnXLSX').addEventListener('click', () => {
      // ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏á‡πà‡∏≤‡∏¢: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏ï‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .xlsx ‚Äî Excel ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ
      const blob = toCSV(filteredItems);
      download(`customers-${new Date().toISOString().slice(0,10)}.xlsx`, blob);
    });

    /********** Wiring **********/
    $('btnApply').addEventListener('click', applyFiltersAndRender);
    $('reportTopic').addEventListener('change', () => {
      const t = $('reportTopic').value;
      const needGroup = ['avg_price_group','avg_age_group'].includes(t);
      $('groupBy').disabled = !needGroup; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ avg
      updateChart(filteredItems);
    });

    // init default date range + first render
    setDefaultRange();
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡πà‡∏≤‡∏á ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô
    applyFiltersAndRender();
  </script>
</body>
</html>
