<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Public)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box} body{font-family:'Sarabun',sans-serif}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <header class="bg-white/80 backdrop-blur sticky top-0 z-40 border-b border-gray-200">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üìã</span>
        <h1 class="text-lg md:text-xl font-semibold text-gray-800">‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏î‡∏π‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (DATALEAD)</h1>
      </div>
      <a href="./admin-report-enhanced.html" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚ûú</a>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- Tips -->
    <div class="text-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
      <p class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)</p>
   <!--   <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-4xl mx-auto text-left">
        <ul class="list-disc ml-5 text-xs text-blue-700 space-y-1">
          <li>‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö Firestore Rules)</li>
          <li>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‚Äî ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÉ‡∏ô ‚Äú‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ role)</li>
        </ul> 
      </div>-->
    </div>

    <!-- Flash message -->
    <div id="flash" class="hidden max-w-3xl mx-auto mb-4 px-4 py-3 rounded-lg text-sm"></div>

    <!-- Form -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-3xl mx-auto">
      <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
        <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">+</span>
        ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      </h3>
      <form id="customerForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
            <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="tel" id="phone" placeholder="08X-XXX-XXXX" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required/>
          </div>
        </div>

        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏û‡∏®</label>
              <select id="gender" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏≤‡∏¢‡∏∏</label>
              <input type="number" id="age" min="1" max="120" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required/>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
            <input type="text" id="disease" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
            <textarea id="specialCare" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>

        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</label>
            <select id="roomType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
              <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option>
              <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏≤‡∏¢</option>
              <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
              <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 2 ‡∏ó‡πà‡∏≤‡∏ô</option>
              <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 3 ‡∏ó‡πà‡∏≤‡∏ô</option>
              <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 5 ‡∏ó‡πà‡∏≤‡∏ô</option>
              <option>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠ (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="price" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required/>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="decision" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
              <option>‡πÉ‡∏´‡∏°‡πà</option>
              <option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option>
              <option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
              <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option>
              <option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
              <option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
              <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option>
              <option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
              <option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
            </select>
          </div>
        </div>

        <div class="md:col-span-2">
          <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold py-3 rounded-lg hover:from-blue-600 hover:to-blue-700 transition">
            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          </button>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-semibold text-gray-800 flex items-center">
          <span class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">üìä</span>
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        </h3>
        <div class="text-sm text-gray-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total" class="font-semibold text-blue-600">0</span> ‡∏Ñ‡∏ô</div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-50">
              <th class="px-3 py-2 text-left">#</th>
              <th class="px-3 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="px-3 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="px-3 py-2 text-left">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th class="px-3 py-2 text-left">‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏</th>
              <th class="px-3 py-2 text-left">‡∏´‡πâ‡∏≠‡∏á</th>
              <th class="px-3 py-2 text-left">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
              <th class="px-3 py-2 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="list" class="divide-y divide-gray-200">
            <tr id="emptyState">
              <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                <div class="flex flex-col items-center">
                  <span class="text-4xl mb-2">üìù</span>
                  <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                  <p class="text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // --- Init ---
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // --- Refs / Utils ---
    const colRef = collection(db, "customers");
    const q = query(colRef, orderBy("createdAt","desc"));

    const fmtTH = (s)=>{ const d=new Date(s); return isNaN(d) ? '-' : d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}) };
    const fmtNum = (n)=> new Intl.NumberFormat('th-TH').format(n||0);

    function flash(msg, type='info'){
      const box = document.getElementById('flash');
      const styles = {
        info:'bg-blue-50 text-blue-800 border border-blue-200',
        ok:'bg-emerald-50 text-emerald-800 border border-emerald-200',
        err:'bg-red-50 text-red-800 border border-red-200',
      };
      box.className = `max-w-3xl mx-auto mb-4 px-4 py-3 rounded-lg text-sm ${styles[type]||styles.info}`;
      box.textContent = msg;
      box.classList.remove('hidden');
      setTimeout(()=> box.classList.add('hidden'), 3000);
    }

    // --- Table render (live) ---
    onSnapshot(q, (snap)=>{
      const tbody = document.getElementById('list');
      const total = document.getElementById('total');
      if (snap.empty){
        total.textContent = 0;
        tbody.innerHTML = document.getElementById('emptyState').outerHTML;
        return;
      }
      let i=1;
      tbody.innerHTML = Array.from(snap.docs).map(d=>{
        const c=d.data();
        return `<tr class="hover:bg-gray-50">
          <td class="px-3 py-2">${i++}</td>
          <td class="px-3 py-2">${fmtTH(c.date)}</td>
          <td class="px-3 py-2 font-medium">${c.name ?? '-'}</td>
          <td class="px-3 py-2">${c.phone ?? '-'}</td>
          <td class="px-3 py-2">${c.gender ?? '-'} / ${c.age ?? '-'} ‡∏õ‡∏µ</td>
          <td class="px-3 py-2">${c.roomType ?? '-'}</td>
          <td class="px-3 py-2">‡∏ø${fmtNum(c.price)}</td>
          <td class="px-3 py-2">${c.decision ?? '-'}</td>
        </tr>`;
      }).join('');
      total.textContent = snap.size;
    }, (err)=>{
      console.error('onSnapshot error:', err);
      flash('‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || err.code || err), 'err');
    });

    // --- Add ---
    const form = document.getElementById('customerForm');
    const dateEl = document.getElementById('date');
    dateEl.valueAsDate = new Date();

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const btn = form.querySelector('button[type="submit"]');
      const btnPrev = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try{
        const payload = {
          date: document.getElementById('date').value,
          name: document.getElementById('name').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          gender: document.getElementById('gender').value,
          age: Number(document.getElementById('age').value || 0),
          disease: document.getElementById('disease').value || '',
          specialCare: document.getElementById('specialCare').value || '',
          roomType: document.getElementById('roomType').value,
          price: Number(document.getElementById('price').value || 0),
          decision: document.getElementById('decision').value,
          createdAt: serverTimestamp(),
        };

        // Validate minimal required
        if (!payload.date || !payload.name || !payload.phone || !payload.gender || !payload.age || !payload.roomType || !payload.decision){
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        }

        await addDoc(colRef, payload);

        form.reset();
        dateEl.valueAsDate = new Date();

        flash('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'ok');
        btn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
        btn.classList.add('bg-green-600','from-green-500','to-green-600');
        setTimeout(()=>{
          btn.innerHTML = btnPrev;
          btn.classList.remove('bg-green-600','from-green-500','to-green-600');
        }, 1200);
      }catch(err){
        console.error('Add failed:', err);
        const map = {
          'permission-denied': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏£‡∏ß‡∏à Firestore Rules)',
          'failed-precondition': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firestore ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏±‡∏ä‡∏ô‡∏µ',
          'unavailable': '‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        };
        const code = (err.code || '').split('/').pop(); // e.g. permission-denied
        flash(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${map[code] || err.message || code}`, 'err');
        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.code || ''} ${err.message || ''}`);
      }finally{
        btn.disabled = false;
        if (btn.innerHTML.includes('‚è≥')) btn.innerHTML = btnPrev;
      }
    });
  </script>
</body>
</html>
