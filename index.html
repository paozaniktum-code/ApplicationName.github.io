<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äî ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô/‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î (Firebase)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js + Funnel plugin + SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-funnel@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    *{box-sizing:border-box}body{font-family:'Sarabun',sans-serif}
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid rgba(0,0,0,.08);font-size:.75rem}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem;box-shadow:0 4px 20px rgba(0,0,0,.05)}
    select[multiple]{min-height:8.5rem}
    .scroll-sm{max-height:18rem;overflow:auto}
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-blue-100 min-h-screen">
  <!-- Topbar -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üõ†Ô∏è</span>
        <h1 class="text-lg font-semibold text-gray-800">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô & ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h1>
      </div>
      <div class="flex items-center gap-3">
        <span id="userBadge" class="badge bg-blue-50 text-blue-700">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: -</span>
        <a href="/" class="badge hover:bg-gray-100">‚Ü© ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ</a>
        <button id="logoutBtn" class="px-3 py-1.5 rounded-lg bg-red-500 text-white hover:bg-red-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Filters & Topic Controls -->
    <div class="card p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="block text-xs text-gray-600 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
          <select id="reportTopic" class="w-full border rounded-lg px-3 py-2">
            <option value="status">‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="roomType">‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</option>
            <option value="gender">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®</option>
            <option value="monthlyRevenue">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
            <option value="avg">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏≠‡∏≤‡∏¢‡∏∏)</option>
            <option value="monthlyConversion">Conversion Rate ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
            <option value="funnel">Funnel (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</option>
            <option value="stacked">Stacked Bar (‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)</option>
          </select>
        </div>
        <!-- NEW: Avg group by selector -->
        <div id="avgGroupWrap" class="hidden">
          <label class="block text-xs text-gray-600 mb-1">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
          <select id="avgGroupBy" class="w-full border rounded-lg px-3 py-2">
            <option value="status">‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="gender">‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®</option>
            <option value="roomType">‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</option>
            <option value="month">‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
          </select>
        </div>
        <!-- NEW: Stacked options -->
        <div id="stackedWrap" class="hidden md:col-span-2">
          <label class="block text-xs text-gray-600 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ö‡∏ö Stacked</label>
          <select id="stackedKind" class="w-full border rounded-lg px-3 py-2">
            <option value="monthlyRevenueByRoom">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Stacked ‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á)</option>
            <option value="monthlyCountByStatus">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Stacked ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
          <input id="dateFrom" type="date" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)</label>
          <input id="dateTo" type="date" class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
        <div>
          <label class="block text-xs text-gray-600 mb-1">‡∏Å‡∏£‡∏≠‡∏á ‚Äú‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‚Äù (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤)</label>
          <select id="statusFilterMulti" class="w-full border rounded-lg px-3 py-2 scroll-sm" multiple>
            <option>‡πÉ‡∏´‡∏°‡πà</option>
            <option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option>
            <option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
            <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option>
            <option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
            <option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
            <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option>
            <option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
            <option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">‡∏Å‡∏£‡∏≠‡∏á ‚Äú‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‚Äù (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤)</label>
          <select id="roomFilterMulti" class="w-full border rounded-lg px-3 py-2 scroll-sm" multiple>
            <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏≤‡∏¢</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 2 ‡∏ó‡πà‡∏≤‡∏ô</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 3 ‡∏ó‡πà‡∏≤‡∏ô</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 5 ‡∏ó‡πà‡∏≤‡∏ô</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button id="applyFilter" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 w-full">üîç ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
        </div>
        <div class="flex items-end gap-2">
          <button id="exportJSON" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 w-full">üíæ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON</button>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-3">
        <button id="exportCSV" class="px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
        <button id="exportXLSX" class="px-3 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel (.xlsx)</button>
      </div>
    </div>

    <!-- Charts & Table -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card p-4 lg:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold text-gray-800">‡∏Å‡∏£‡∏≤‡∏ü</h2>
          <span id="summaryBadge" class="badge bg-gray-50">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <canvas id="reportChart" height="120"></canvas>
      </div>
      <div class="card p-4">
        <h2 class="font-semibold text-gray-800 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h2>
        <div id="quickStats" class="text-sm text-gray-700 space-y-1">
          <div>‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <b><span id="statTotal">0</span></b></div>
          <div>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î): <b><span id="statAvgPrice">-</span></b></div>
          <div>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î): <b><span id="statAvgAge">-</span></b></div>
          <div>Conversion Rate ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b><span id="statConv">-</span></b></div>
        </div>
      </div>
    </div>

    <div class="card p-4 mt-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á)</h2>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left">#</th>
              <th class="px-3 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="px-3 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="px-3 py-2 text-left">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th class="px-3 py-2 text-left">‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏</th>
              <th class="px-3 py-2 text-left">‡∏´‡πâ‡∏≠‡∏á</th>
              <th class="px-3 py-2 text-left">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
              <th class="px-3 py-2 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Firebase & App Logic -->
  <script type="module">
    /***********************
     * 1) Firebase Config
     ***********************/
   const firebaseConfig = {
  apiKey: "AIzaSyA4onNF2FmdJti7_fX6swoa-cqdq3xojTk",
  authDomain: "lead-54035.firebaseapp.com",
  projectId: "lead-54035",
  storageBucket: "lead-54035.firebasestorage.app",
  messagingSenderId: "993343538703",
  appId: "1:993343538703:web:51ba10b9296b4716fa457a",
  measurementId: "G-KB5ZRKN3T5"
};

    // Firebase SDK (v10)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const $ = (s,sc=document)=>sc.querySelector(s);
    const $$ = (s,sc=document)=>[...sc.querySelectorAll(s)];
    const reportTopic = $('#reportTopic');
    const avgGroupWrap = $('#avgGroupWrap');
    const avgGroupBy = $('#avgGroupBy');
    const stackedWrap = $('#stackedWrap');
    const stackedKind = $('#stackedKind');

    const tableBody = $('#tableBody');
    const summaryBadge = $('#summaryBadge');
    const statTotal = $('#statTotal');
    const statAvgPrice = $('#statAvgPrice');
    const statAvgAge = $('#statAvgAge');
    const statConv = $('#statConv');

    const ctx = $('#reportChart').getContext('2d');
    let chart;

    // App state
    let items = []; // all docs from Firestore

    // Auth
    onAuthStateChanged(auth, (user)=>{
      if(!user){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡∏Å‡πà‡∏≠‡∏ô');
        location.href = '/';
        return;
      }
      $('#userBadge').textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.email || user.uid}`;
      bindRealtime();
    });
    $('#logoutBtn').addEventListener('click', ()=> signOut(auth));

    // Firestore realtime
    function bindRealtime(){
      const colRef = collection(db,'customers');
      const qy = query(colRef, orderBy('createdAt','desc'));
      onSnapshot(qy, (snap)=>{
        items = [];
        snap.forEach(d=> items.push({ id:d.id, ...d.data() }));
        applyReport();
      });
    }

    // UI: topic toggles
    reportTopic.addEventListener('change', ()=>{
      const v = reportTopic.value;
      avgGroupWrap.classList.toggle('hidden', v!=='avg');
      stackedWrap.classList.toggle('hidden', v!=='stacked');
      applyReport();
    });
    avgGroupBy.addEventListener('change', applyReport);
    stackedKind.addEventListener('change', applyReport);

    // Defaults: this month
    const now = new Date();
    const from = new Date(now.getFullYear(), now.getMonth(), 1);
    const to = new Date(now.getFullYear(), now.getMonth()+1, 0);
    $('#dateFrom').valueAsDate = from;
    $('#dateTo').valueAsDate = to;

    $('#applyFilter').addEventListener('click', applyReport);

    // Export buttons
    $('#exportJSON').addEventListener('click', ()=>{
      const filtered = getFiltered(items);
      downloadJSON(filtered, `customers-filtered-${dateStamp()}.json`);
    });
    $('#exportCSV').addEventListener('click', ()=>{
      const filtered = getFiltered(items);
      const csv = toCSV(filtered);
      downloadBlob(new Blob([csv], {type:'text/csv;charset=utf-8;'}), `customers-filtered-${dateStamp()}.csv`);
    });
    $('#exportXLSX').addEventListener('click', ()=>{
      const filtered = getFiltered(items);
      exportXLSX(filtered, `customers-filtered-${dateStamp()}.xlsx`);
    });

    // ========= Report core =========
    function applyReport(){
      const filtered = getFiltered(items);
      renderTable(filtered);
      renderStats(filtered);
      renderChart(filtered);
    }

    function getFiltered(list){
      const df = $('#dateFrom').value ? new Date($('#dateFrom').value) : null;
      const dt = $('#dateTo').value ? new Date($('#dateTo').value) : null;
      const pickMulti = (sel)=> [...$(sel).selectedOptions].map(o=>o.value);
      const statusPicked = pickMulti('#statusFilterMulti');
      const roomPicked = pickMulti('#roomFilterMulti');

      return list.filter(c=>{
        // date filter by c.date (YYYY-MM-DD)
        if(df || dt){
          const t = c.date ? new Date(c.date) : null;
          if(!t) return false;
          if(df && t < startOfDay(df)) return false;
          if(dt && t > endOfDay(dt)) return false;
        }
        if(statusPicked.length && !statusPicked.includes(c.decision||'')) return false;
        if(roomPicked.length && !roomPicked.includes(c.roomType||'')) return false;
        return true;
      });
    }

    function renderStats(rows){
      summaryBadge.textContent = `‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      statTotal.textContent = rows.length;
      statAvgPrice.textContent = fmtNumber(avg(rows.map(r=>Number(r.price||0))));
      statAvgAge.textContent = fmtNumber(avg(rows.map(r=>Number(r.age||0))));
      const conv = conversionRate(rows);
      statConv.textContent = conv==null?'-': `${(conv*100).toFixed(1)}%`;
    }

    function renderTable(rows){
      tableBody.innerHTML = rows.map((c,i)=>`
        <tr class="hover:bg-gray-50">
          <td class="px-3 py-2">${i+1}</td>
          <td class="px-3 py-2">${fmtDate(c.date)}</td>
          <td class="px-3 py-2">${esc(c.name)}</td>
          <td class="px-3 py-2">${esc(c.phone)}</td>
          <td class="px-3 py-2">${esc(c.gender)} / ${Number(c.age||0)}</td>
          <td class="px-3 py-2">${esc(c.roomType)}</td>
          <td class="px-3 py-2">${fmtNumber(c.price||0)}</td>
          <td class="px-3 py-2">${esc(c.decision)}</td>
        </tr>
      `).join('');
    }

    function renderChart(rows){
      const topic = reportTopic.value;
      if(chart) chart.destroy();

      if(topic==='status'){
        const m = groupCount(rows, r=>r.decision||'-');
        const {labels, data} = toSeries(m);
        chart = new Chart(ctx, cfgBar(labels, data, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'));
      }
      else if(topic==='roomType'){
        const m = groupCount(rows, r=>r.roomType||'-');
        const {labels, data} = toSeries(m);
        chart = new Chart(ctx, cfgBar(labels, data, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á'));
      }
      else if(topic==='gender'){
        const m = groupCount(rows, r=>r.gender||'-');
        const {labels, data} = toSeries(m);
        chart = new Chart(ctx, cfgDoughnut(labels, data, '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®'));
      }
      else if(topic==='monthlyRevenue'){
        const m = groupSum(rows, r=> ym(new Date(r.date)), r=> Number(r.price||0));
        const {labels, data} = toSeries(sortMapByKey(m));
        chart = new Chart(ctx, cfgBar(labels, data, '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'));
      }
      else if(topic==='avg'){
        const by = avgGroupBy.value; // status | gender | roomType | month
        const keyFn =
          by==='status'   ? (r)=>r.decision||'-' :
          by==='gender'   ? (r)=>r.gender||'-'   :
          by==='roomType' ? (r)=>r.roomType||'-' :
          (r)=> ym(new Date(r.date));
        // ‡πÅ‡∏™‡∏î‡∏á 2 ‡∏ä‡∏∏‡∏î: Avg Price & Avg Age
        const avgPrice = groupAvg(rows, keyFn, r=>Number(r.price||0));
        const avgAge   = groupAvg(rows, keyFn, r=>Number(r.age||0));
        const keys = uniq([ ...avgPrice.keys(), ...avgAge.keys() ]).sort();
        const ds1 = keys.map(k=> avgPrice.get(k) ?? 0);
        const ds2 = keys.map(k=> avgAge.get(k) ?? 0);
        chart = new Chart(ctx, {
          type:'bar',
          data:{ labels: keys, datasets:[
            {label:'Avg Price', data: ds1},
            {label:'Avg Age', data: ds2}
          ]},
          options:{ responsive:true, plugins:{ title:{display:true,text:`‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏Å‡∏•‡∏∏‡πà‡∏°: ${by})`} }, scales:{ y:{ beginAtZero:true } } }
        });
      }
      else if(topic==='monthlyConversion'){
        const byMonth = new Map();
        for(const r of rows){
          const k = ym(new Date(r.date));
          if(!byMonth.has(k)) byMonth.set(k,{win:0,total:0});
          const o=byMonth.get(k); o.total++; if((r.decision||'')==='‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') o.win++;
        }
        const arr = [...byMonth.entries()].sort((a,b)=> a[0].localeCompare(b[0]));
        const labels = arr.map(([m])=>m);
        const data = arr.map(([_,v])=> v.total? +(v.win*100/v.total).toFixed(1) : 0);
        chart = new Chart(ctx, cfgLine(labels, data, 'Conversion Rate ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (%)'));
      }
      else if(topic==='funnel'){
        const stages = ['‡πÉ‡∏´‡∏°‡πà','‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö','‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à','‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà','‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à','‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'];
        const counts = new Map(stages.map(s=>[s,0]));
        for(const r of rows){ const s=r.decision||'-'; if(counts.has(s)) counts.set(s, counts.get(s)+1); }
        const data = stages.map(s=> counts.get(s)||0);
        chart = new Chart(ctx, {
          type:'funnel',
          data:{ labels: stages, datasets:[{ data, label:'Funnel' }] },
          options:{ plugins:{ title:{display:true,text:'Sales Funnel (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)'} } }
        });
      }
      else if(topic==='stacked'){
        const kind = stackedKind.value; // monthlyRevenueByRoom | monthlyCountByStatus
        if(kind==='monthlyRevenueByRoom'){
          // group: month -> roomType -> sum(price)
          const map = new Map();
          for(const r of rows){
            const m = ym(new Date(r.date));
            const room = r.roomType||'-';
            if(!map.has(m)) map.set(m, new Map());
            const mm = map.get(m);
            mm.set(room, (mm.get(room)||0) + Number(r.price||0));
          }
          renderStacked(map, '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Stacked ‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á)');
        } else {
          // group: month -> status -> count
          const map = new Map();
          for(const r of rows){
            const m = ym(new Date(r.date));
            const st = r.decision||'-';
            if(!map.has(m)) map.set(m, new Map());
            const mm = map.get(m);
            mm.set(st, (mm.get(st)||0) + 1);
          }
          renderStacked(map, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Stacked ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)');
        }
      }
    }

    function renderStacked(monthMap, title){
      const months = [...monthMap.keys()].sort();
      // collect all sub-keys
      const subkeys = new Set();
      months.forEach(m=> monthMap.get(m).forEach((_,k)=> subkeys.add(k)));
      const keys = [...subkeys];
      const datasets = keys.map(k=>({ label:k, data: months.map(m=> monthMap.get(m).get(k)||0), stack:'stack1' }));
      chart = new Chart(ctx, {
        type:'bar',
        data:{ labels: months, datasets },
        options:{
          responsive:true,
          plugins:{ title:{display:true,text:title} },
          scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
        }
      });
    }

    // ========= Helpers =========
    function groupCount(arr, keyFn){ const m=new Map(); for(const x of arr){ const k=keyFn(x); m.set(k,(m.get(k)||0)+1);} return m; }
    function groupSum(arr, keyFn, valFn){ const m=new Map(); for(const x of arr){ const k=keyFn(x); m.set(k,(m.get(k)||0)+valFn(x)); } return m; }
    function groupAvg(arr, keyFn, valFn){
      const m=new Map();
      for(const x of arr){ const k=keyFn(x); const v=Number(valFn(x)||0); if(!m.has(k)) m.set(k,{sum:0,n:0}); const o=m.get(k); o.sum+=v; o.n++; }
      const out=new Map(); m.forEach((v,k)=> out.set(k, v.n? +(v.sum/v.n).toFixed(2):0)); return out;
    }
    function sortMapByKey(map){ return new Map([...map.entries()].sort((a,b)=>a[0].localeCompare(b[0]))); }
    function toSeries(map){ const entries=[...map.entries()]; return {labels:entries.map(e=>e[0]), data:entries.map(e=>e[1])}; }
    function uniq(arr){ return [...new Set(arr)]; }

    // Chart presets
    function cfgBar(labels,data,title){ return { type:'bar', data:{ labels, datasets:[{label:title, data}] }, options:{ responsive:true, plugins:{ title:{display:true,text:title} }, scales:{ y:{ beginAtZero:true } } } }; }
    function cfgLine(labels,data,title){ return { type:'line', data:{ labels, datasets:[{label:title, data, tension:.25}] }, options:{ responsive:true, plugins:{ title:{display:true,text:title} }, scales:{ y:{ beginAtZero:true } } } }; }
    function cfgDoughnut(labels,data,title){ return { type:'doughnut', data:{ labels, datasets:[{ data }] }, options:{ responsive:true, plugins:{ title:{display:true,text:title} } } }; }

    // Utils
    function fmtDate(s){ const d=new Date(s); return isNaN(d)?'-': d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}); }
    function startOfDay(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0); }
    function endOfDay(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59,999); }
    function ym(d){ if(!d||isNaN(d)) return '-'; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function avg(nums){ const arr=nums.filter(n=>Number.isFinite(n)); return arr.length? +(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2): 0; }
    function conversionRate(rows){
      const total = rows.length; if(!total) return null; const win = rows.filter(r=> (r.decision||'')==='‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').length; return win/total; }
    function fmtNumber(n){ return new Intl.NumberFormat('th-TH').format(Number(n)||0); }
    function esc(s){ return (s??'').toString().replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function dateStamp(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

    function downloadJSON(obj, filename){
      const data = JSON.stringify(obj,null,2);
      downloadBlob(new Blob([data],{type:'application/json'}), filename);
    }
    function toCSV(rows){
      const headers = ['id','date','name','phone','gender','age','roomType','price','decision'];
      const escCSV = (v)=> '"'+ String(v??'').replace(/"/g,'""') +'"';
      const lines = [ headers.join(',') ];
      for(const r of rows){
        lines.push(headers.map(h=> escCSV(r[h])).join(','));
      }
      return lines.join('\n');
    }
    function exportXLSX(rows, filename){
      const headers = ['id','date','name','phone','gender','age','roomType','price','decision'];
      const data = [ headers, ...rows.map(r=> headers.map(h=> r[h] ?? '')) ];
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Filtered');
      XLSX.writeFile(wb, filename);
    }
    function downloadBlob(blob, filename){
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename; link.click();
      setTimeout(()=> URL.revokeObjectURL(link.href), 1500);
    }
  </script>
</body>
</html>
