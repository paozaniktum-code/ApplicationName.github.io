<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚Äî ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    body{font-family:'Sarabun',sans-serif}
    .chip{background:#eef2ff;color:#3730a3;padding:.30rem .7rem;border-radius:9999px;font-size:.85rem}
    .chip-amber{background:#fef3c7;color:#92400e}
    .pill{background:#e0f2fe;color:#0369a1;border-radius:9999px;padding:.45rem .8rem}
    .btn{border-radius:.75rem;padding:.6rem 1rem;font-weight:600}
  </style>
</head>
<body class="bg-sky-50 min-h-screen">
  <!-- Top -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-2xl font-bold flex items-center gap-2">
        üìö <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
      </h1>
      <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô Report ‚Üí Export</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- FILTER BAR -->
    <section class="bg-white rounded-xl shadow p-4 mb-4">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-center">
        <div class="lg:col-span-5">
          <input id="qText" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏´‡πâ‡∏≠‡∏á/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                 class="w-full border rounded-lg px-4 py-2.5 focus:ring focus:ring-blue-200"/>
        </div>
        <div class="lg:col-span-2">
          <select id="qStatus" class="w-full border rounded-lg px-3 py-2.5">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option>‡πÉ‡∏´‡∏°‡πà</option>
            <option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option>
            <option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
            <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option>
            <option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
            <option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
            <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option>
            <option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
            <option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
          </select>
        </div>
        <div class="lg:col-span-2">
          <select id="qRoom" class="w-full border rounded-lg px-3 py-2.5">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 2 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 3 ‡∏ó‡πà‡∏≤‡∏ô</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 5 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
          </select>
        </div>
        <div class="lg:col-span-2">
          <select id="qGender" class="w-full border rounded-lg px-3 py-2.5">
            <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏û‡∏®</option>
            <option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option>
          </select>
        </div>
        <div class="lg:col-span-1 flex gap-2">
          <button id="btnApply" class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
        </div>
        <div class="lg:col-span-12 flex items-center justify-end text-sm text-gray-600 gap-2">
          <button id="btnClear" class="btn bg-gray-200 hover:bg-gray-300 text-gray-800">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
          <span class="ml-auto">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="allCount">0</b> ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: <b id="showCount">0</b></span>
        </div>
      </div>
    </section>

    <!-- REPORT (columns + export) -->
    <section class="bg-white rounded-xl shadow p-4 mb-6">
      <div class="flex items-start gap-4">
        <div class="flex-1">
          <div class="text-lg font-semibold mb-2">Report ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-[15px]">
            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="date" checked> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="name" checked> ‡∏ä‡∏∑‡πà‡∏≠</label>
            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="phone" checked> ‡πÄ‡∏ö‡∏≠‡∏£‡πå</label>
            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="gender"> ‡πÄ‡∏û‡∏®</label>

            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="age"> ‡∏≠‡∏≤‡∏¢‡∏∏</label>
            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="price"> ‡∏£‡∏≤‡∏Ñ‡∏≤</label>
            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="disease"> ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="specialCare"> ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>

            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="roomType" checked> ‡∏´‡πâ‡∏≠‡∏á</label>
            <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="decision" checked> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          </div>

          <div class="flex flex-wrap gap-2 mt-4">
            <button id="exportCsv"  class="btn bg-emerald-500 hover:bg-emerald-600 text-white">‚¨áÔ∏è Export CSV</button>
            <button id="exportJson" class="btn bg-emerald-500 hover:bg-emerald-600 text-white">‚¨áÔ∏è Export JSON</button>
            <button id="exportXlsx" class="btn bg-emerald-500 hover:bg-emerald-600 text-white">‚¨áÔ∏è Export Excel</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</p>
        </div>
        <div class="w-64 hidden md:block">
          <div class="text-gray-700 font-medium mb-2">‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ‚Äú‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‚Äù</div>
          <label class="flex items-center gap-2"><input class="colChk" type="checkbox" value="roomType" checked disabled> ‡∏´‡πâ‡∏≠‡∏á</label>
        </div>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="result" class="space-y-3"></section>
  </main>

  <!-- Detail Modal -->
  <template id="detailTpl">
    <div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-xl w-[560px] max-w-[92vw] p-5">
        <h3 class="text-lg font-bold mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
        <div id="detailBody" class="text-gray-700 whitespace-pre-wrap"></div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="closeBtn" class="btn bg-gray-200 hover:bg-gray-300 text-gray-800">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
  </template>

  <!-- App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // ---- Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---- Refs
    const qText    = document.getElementById('qText');
    const qStatus  = document.getElementById('qStatus');
    const qRoom    = document.getElementById('qRoom');
    const qGender  = document.getElementById('qGender');
    const btnApply = document.getElementById('btnApply');
    const btnClear = document.getElementById('btnClear');
    const allCount = document.getElementById('allCount');
    const showCount= document.getElementById('showCount');
    const resultEl = document.getElementById('result');

    const exportCsvBtn  = document.getElementById('exportCsv');
    const exportJsonBtn = document.getElementById('exportJson');
    const exportXlsxBtn = document.getElementById('exportXlsx');

    // ---- State
    let isAdmin = false;
    let allItems = [];
    let viewItems = [];

    // ---- Auth
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='index.html'; return; }
      try{
        const tk = await getIdTokenResult(user,true);
        isAdmin = (tk.claims.role || tk.claims.customRole) === 'admin';
      }catch{ isAdmin = false; }
      startRealtime();
    });

    // ---- Firestore realtime
    function startRealtime(){
      const qy = query(collection(db,'customers'), orderBy('createdAt','desc'));
      onSnapshot(qy, (snap)=>{
        allItems = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        allCount.textContent = allItems.length;
        applyFilter();
      });
    }

    // ---- Helpers
    const fmtTH = s => { const d=new Date(s); return isNaN(d)?'-':d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}); };
    const fmtNum = n => new Intl.NumberFormat('th-TH').format(n||0);
    const tel = p => (p||'').replace(/\s+/g,'');

    function matchesKw(c, kw){
      if(!kw) return true;
      kw = kw.toLowerCase();
      return [
        c.name, c.phone, c.gender, c.roomType, c.decision, c.disease, c.specialCare
      ].map(v=>(v??'').toString().toLowerCase()).join(' ').includes(kw);
    }

    // ---- Filter
    function applyFilter(){
      const kw = qText.value.trim();
      const st = qStatus.value;
      const room = qRoom.value;
      const sex = qGender.value;

      viewItems = allItems.filter(c=>{
        if(!matchesKw(c,kw)) return false;
        if(st   && (c.decision||'') !== st) return false;
        if(room && (c.roomType||'') !== room) return false;
        if(sex  && (c.gender||'')   !== sex) return false;
        return true;
      });

      showCount.textContent = viewItems.length;
      renderList();
    }
    btnApply.addEventListener('click', applyFilter);
    btnClear.addEventListener('click', ()=>{
      qText.value=''; qStatus.value=''; qRoom.value=''; qGender.value='';
      applyFilter();
    });
    qText.addEventListener('keydown', e=>{ if(e.key==='Enter') applyFilter(); });

    // ---- Render
    function renderList(){
      if(!viewItems.length){
        resultEl.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
      }
      resultEl.innerHTML = viewItems.map(c=> `
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-sm text-gray-500 mb-1">${fmtTH(c.date)}</div>
              <div class="text-2xl font-semibold text-gray-900">${c.name||'-'}</div>
              <div class="mt-1 flex flex-wrap items-center gap-2 text-gray-700">
                <a class="pill flex items-center gap-1 hover:underline" href="tel:${tel(c.phone)}">üìû <span>${c.phone||'-'}</span></a>
                <span class="chip">‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏: ${c.gender||'-'} / ${c.age||'-'} ‡∏õ‡∏µ</span>
                <span class="chip">‡∏´‡πâ‡∏≠‡∏á: ${c.roomType||'-'}</span>
                <span class="chip">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${fmtNum(c.price)}</span>
                <span class="chip chip-amber">${c.decision||'-'}</span>
              </div>
            </div>
            <div class="shrink-0 flex gap-2">
              <button class="btn bg-white border text-gray-800 hover:bg-gray-50" onclick="viewDetail('${c.id}')">üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              ${isAdmin? `<button class="btn bg-rose-500 hover:bg-rose-600 text-white" onclick="deleteCustomer('${c.id}')">üóëÔ∏è ‡∏•‡∏ö</button>`:''}
            </div>
          </div>
        </div>
      `).join('');
    }

    // ---- Actions
    window.viewDetail = (id)=>{
      const c = viewItems.find(v=>v.id===id) || allItems.find(v=>v.id===id);
      if(!c) return;
      const tpl = document.getElementById('detailTpl').content.cloneNode(true);
      const root = tpl.querySelector('div');
      const body = tpl.querySelector('#detailBody');
      body.textContent =
`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fmtTH(c.date)}
‡∏ä‡∏∑‡πà‡∏≠: ${c.name||'-'}
‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${c.phone||'-'}
‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏: ${c.gender||'-'} / ${c.age||'-'} ‡∏õ‡∏µ
‡∏´‡πâ‡∏≠‡∏á: ${c.roomType||'-'}
‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${fmtNum(c.price)}
‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${c.decision||'-'}
‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${c.disease||'-'}
‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©: ${c.specialCare||'-'}`;
      tpl.querySelector('#closeBtn').addEventListener('click', ()=> document.body.removeChild(root));
      document.body.appendChild(root);
    };

    window.deleteCustomer = async (id)=>{
      if(!isAdmin) return alert('‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
      if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) await deleteDoc(doc(db,'customers',id));
    };

    // ---- Export
    const getCols=()=> Array.from(document.querySelectorAll('.colChk:checked')).map(x=>x.value);
    const mapRow=(c,cols)=> cols.map(k=> k==='date'? fmtTH(c.date) : (c[k] ?? '') );

    function download(name, blob){
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
    }

    exportCsvBtn.addEventListener('click', ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols=getCols();
      const header=cols.join(',');
      const rows=viewItems.map(c=>mapRow(c,cols).map(v=>{
        v=(v??'').toString(); return /[",\n]/.test(v)? `"${v.replace(/"/g,'""')}"` : v;
      }).join(',')).join('\n');
      download(`report-${new Date().toISOString().slice(0,10)}.csv`, new Blob([header+'\n'+rows],{type:'text/csv;charset=utf-8;'}));
    });

    exportJsonBtn.addEventListener('click', ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols=getCols();
      const arr=viewItems.map(c=>{ const o={}; cols.forEach(k=>o[k]=k==='date'?fmtTH(c.date):c[k]??''); return o; });
      download(`report-${new Date().toISOString().slice(0,10)}.json`, new Blob([JSON.stringify(arr,null,2)],{type:'application/json'}));
    });

    // Excel (XLS format via HTML table ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô Excel)
    exportXlsxBtn.addEventListener('click', ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols=getCols();
      const th=cols.map(c=>`<th style="border:1px solid #ddd;padding:6px;text-align:left">${c}</th>`).join('');
      const trs=viewItems.map(c=>{
        const tds=mapRow(c,cols).map(v=>`<td style="border:1px solid #ddd;padding:6px">${(v??'').toString()
          .replace(/&/g,'&amp;').replace(/</g,'&lt;')}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      const html=`<meta charset="utf-8"><table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
      download(`report-${new Date().toISOString().slice(0,10)}.xls`, new Blob([html],{type:'application/vnd.ms-excel'}));
    });
  </script>
</body>
</html>
