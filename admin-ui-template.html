<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (White Clean UI)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box} body{font-family:'Sarabun',sans-serif}
    .tab-on{color:#0ea5e9;border-color:#0ea5e9}
  </style>
</head>
<body class="bg-white text-slate-800">
  <!-- LOGIN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <form id="loginForm" class="bg-white w-full max-w-sm p-6 rounded-2xl shadow border border-slate-200">
      <div class="flex items-center gap-2 mb-4">
        <div class="w-9 h-9 rounded-full bg-sky-600 text-white grid place-items-center font-bold">A</div>
        <h1 class="text-lg font-bold text-slate-900">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h1>
      </div>
      <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="border rounded-lg w-full px-3 py-2 mb-2 focus:ring-2 focus:ring-sky-300" required />
      <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="border rounded-lg w-full px-3 py-2 mb-3 focus:ring-2 focus:ring-sky-300" required />
      <button class="w-full bg-sky-600 hover:bg-sky-700 text-white rounded-lg py-2.5">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <p id="loginError" class="text-red-600 text-sm mt-2 hidden"></p>
      <p class="text-xs text-slate-500 mt-3">* ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î role ‡πÉ‡∏ô <code>roles/{uid}.role</code> ‡πÄ‡∏õ‡πá‡∏ô <b>admin</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>staff</b></p>
    </form>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">
    <!-- Topbar -->
    <header class="fixed inset-x-0 top-0 h-14 bg-white border-b border-slate-200 z-40">
      <div class="h-full flex items-center justify-between px-4">
        <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡πÄ‡∏°‡∏ô‡∏π + ‡πÇ‡∏•‡πÇ‡∏Å‡πâ + ‡πÅ‡∏ó‡πá‡∏ö + ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö -->
        <div class="flex items-center gap-3">
          <button id="btnMenu" class="md:hidden p-2 rounded hover:bg-slate-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
          </button>
          <div class="flex items-center gap-2 mr-1">
            <div class="w-8 h-8 rounded-full bg-sky-600 text-white grid place-items-center font-bold">A</div>
            <span class="font-bold text-slate-900">App Admin</span>
          </div>

          <nav class="hidden md:flex gap-1 text-sm">
            <button id="tabList"   class="px-3 py-2 border-b-2 border-transparent hover:text-slate-900">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            <button id="tabReport" class="px-3 py-2 border-b-2 border-transparent hover:text-slate-900">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡∏£‡∏∏‡∏õ</button>
          </nav>

          <button id="logoutBtn" class="ml-2 text-xs bg-rose-500 hover:bg-rose-600 text-white px-3 py-1.5 rounded-lg">
            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        </div>

        <!-- ‡∏Ç‡∏ß‡∏≤: badge ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        <div class="flex items-center gap-2">
          <span id="userBadge" class="text-xs bg-slate-100 text-slate-800 border border-slate-200 rounded-full px-3 py-1">-</span>
        </div>
      </div>
    </header>

    <div class="pt-14 flex">
      <!-- Sidebar -->
      <aside id="sidebar" class="fixed md:static z-30 inset-y-14 left-0 w-64 bg-white border-r border-slate-200 transition-transform -translate-x-full md:translate-x-0">
        <div class="h-full flex flex-col">
          <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-slate-100 grid place-items-center">üë§</div>
            <div>
              <div class="text-sm font-semibold text-slate-900">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
              <div id="roleLabel" class="text-[11px] text-slate-500">-</div>
            </div>
          </div>
          <nav class="px-2 py-3 space-y-1 text-sm">
            <button id="sbListBtn"   class="w-full text-left flex items-center gap-2 px-3 py-2 rounded bg-slate-100">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            <button id="sbReportBtn" class="w-full text-left flex items-center gap-2 px-3 py-2 rounded hover:bg-slate-100">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡∏£‡∏∏‡∏õ</button>
          </nav>
          <div class="mt-auto px-4 py-3 text-[11px] text-slate-400">¬© 2025 YourBrand</div>
        </div>
      </aside>

      <!-- Content -->
      <main class="flex-1 w-full md:ml-0">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-6">
          <!-- LIST PAGE -->
          <section id="pageList" class="bg-white rounded-2xl shadow border border-slate-200">
            <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-xl">üë•</span>
                <h2 class="font-bold text-slate-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
              </div>
              <div class="flex items-center gap-2 text-sm">
                <span class="text-slate-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                <b id="total" class="text-slate-900">0</b>
              </div>
            </div>

            <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div class="px-5 py-4 flex items-center gap-3 flex-wrap text-sm">
              <input id="searchBox" type="search" class="border border-slate-200 rounded px-3 py-2 w-full md:w-80 focus:outline-none focus:ring-2 focus:ring-sky-300" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏´‡πâ‡∏≠‡∏á ‚Ä¶">
            </div>

            <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
            <div id="cardList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 px-5 pb-5"></div>
          </section>

          <!-- REPORT PAGE -->
          <section id="pageReport" class="hidden bg-white rounded-2xl shadow border border-slate-200 mt-6">
            <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-xl">üîé</span>
                <h2 class="font-bold text-slate-900">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏≤‡∏ü)</h2>
              </div>
              <div class="text-sm text-slate-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="countAll" class="text-slate-900">0</b></div>
            </div>

            <div class="px-5 py-5 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3">
              <div><label class="text-xs text-slate-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input id="fStart" type="date" class="w-full border rounded-lg px-3 py-2"></div>
              <div><label class="text-xs text-slate-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input id="fEnd" type="date" class="w-full border rounded-lg px-3 py-2"></div>
              <div><label class="text-xs text-slate-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select id="fStatus" class="w-full border rounded-lg px-3 py-2">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option>‡πÉ‡∏´‡∏°‡πà</option><option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option><option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option><option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
                <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
              </select></div>
              <div><label class="text-xs text-slate-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</label><select id="fRoom" class="w-full border rounded-lg px-3 py-2">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 2 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 3 ‡∏ó‡πà‡∏≤‡∏ô</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 5 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
              </select></div>
              <div><label class="text-xs text-slate-500">‡πÄ‡∏û‡∏®</label><select id="fGender" class="w-full border rounded-lg px-3 py-2"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
              <div class="grid grid-cols-2 gap-2">
                <div><label class="text-xs text-slate-500">‡∏£‡∏≤‡∏Ñ‡∏≤ ‚â•</label><input id="fMin" type="number" class="w-full border rounded-lg px-3 py-2"></div>
                <div><label class="text-xs text-slate-500">‡∏£‡∏≤‡∏Ñ‡∏≤ ‚â§</label><input id="fMax" type="number" class="w-full border rounded-lg px-3 py-2"></div>
              </div>
            </div>

            <div class="px-5 pb-5 flex flex-wrap items-center gap-2">
              <button id="btnApply" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg text-sm">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
              <button id="btnReset" class="bg-slate-100 hover:bg-slate-200 text-slate-800 px-4 py-2 rounded-lg text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
              <span class="ml-auto text-sm text-slate-600">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: <b id="countFiltered" class="text-slate-900">0</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>

            <!-- KPI -->
            <div class="px-5 pb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
              <div class="bg-white border border-slate-200 rounded-xl p-4"><div class="text-xs text-slate-500">Leads ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-2xl font-bold" id="kAll">0</div></div>
              <div class="bg-white border border-slate-200 rounded-xl p-4"><div class="text-xs text-slate-500">‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div><div class="text-2xl font-bold" id="kPeriod">0</div></div>
              <div class="bg-white border border-slate-200 rounded-xl p-4"><div class="text-xs text-slate-500">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div><div class="text-2xl font-bold" id="kWon">0</div></div>
              <div class="bg-white border border-slate-200 rounded-xl p-4"><div class="text-xs text-slate-500">Win Rate</div><div class="text-2xl font-bold" id="kWinRate">0%</div></div>
              <div class="bg-white border border-slate-200 rounded-xl p-4"><div class="text-xs text-slate-500">Avg. Price</div><div class="text-2xl font-bold" id="kAvgPrice">‡∏ø0</div></div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal ‡πÅ‡∏Å‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
  <template id="statusModalTpl">
    <div class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-5">
        <h3 class="text-lg font-bold mb-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
        <select id="modalStatus" class="w-full border rounded-lg px-3 py-2 mb-4">
          <option>‡πÉ‡∏´‡∏°‡πà</option><option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option><option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
          <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option><option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
          <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
        </select>
        <div class="flex gap-2">
          <button id="okBtn" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white rounded-lg py-2.5">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button id="cancelBtn" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-800 rounded-lg py-2.5">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </div>
    </div>
  </template>

  <!-- SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, query, orderBy,
      deleteDoc, doc, updateDoc, getDoc, serverTimestamp, deleteField
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    const loginScreen = document.getElementById("loginScreen");
    const dashboard   = document.getElementById("dashboard");
    const loginError  = document.getElementById("loginError");
    const roleLabelEl = document.getElementById("roleLabel");
    const userBadge   = document.getElementById("userBadge");

    const pageList   = document.getElementById("pageList");
    const pageReport = document.getElementById("pageReport");
    const tabList    = document.getElementById("tabList");
    const tabReport  = document.getElementById("tabReport");
    const sbListBtn  = document.getElementById("sbListBtn");
    const sbReportBtn= document.getElementById("sbReportBtn");
    const btnMenu    = document.getElementById("btnMenu");
    const sidebar    = document.getElementById("sidebar");

    const totalEl    = document.getElementById("total");
    const cardListEl = document.getElementById("cardList");
    const searchBox  = document.getElementById("searchBox");

    const fStart = document.getElementById('fStart');
    const fEnd   = document.getElementById('fEnd');
    const fStatus= document.getElementById('fStatus');
    const fRoom  = document.getElementById('fRoom');
    const fGender= document.getElementById('fGender');
    const fMin   = document.getElementById('fMin');  const fMax = document.getElementById('fMax');
    const btnApply = document.getElementById('btnApply'); const btnReset = document.getElementById('btnReset');
    const countAllEl = document.getElementById('countAll'); const countFilteredEl = document.getElementById('countFiltered');
    const kAll = document.getElementById('kAll'); const kPeriod = document.getElementById('kPeriod');
    const kWon = document.getElementById('kWon'); const kWinRate = document.getElementById('kWinRate'); const kAvgPrice = document.getElementById('kAvgPrice');

    const fmtTH=(s)=>{ const d=new Date(s); return isNaN(d)?'-':d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}) };
    const fmtNum=(n)=> new Intl.NumberFormat('th-TH').format(n||0);
    const escapeHtml=(s)=>(s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    function getDateFromDoc(c){ if (c.createdAt?.toDate) return c.createdAt.toDate(); if (c.date){ const d=new Date(c.date+'T00:00:00'); if(!isNaN(d)) return d; } return null; }

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.classList.add("hidden"); loginError.textContent = "";
      try { await signInWithEmailAndPassword(auth, email.value, password.value); }
      catch (err) {
        const map = {
          "auth/operation-not-allowed": "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î Email/Password ‡πÉ‡∏ô Authentication > Sign-in method",
          "auth/invalid-api-key": "firebaseConfig ‡∏ú‡∏¥‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö apiKey / project",
          "auth/invalid-email": "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          "auth/user-not-found": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
          "auth/wrong-password": "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          "auth/network-request-failed": "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢/‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö file:// ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô localhost",
        };
        loginError.textContent = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (map[err.code] || `${err.code} ‚Äî ${err.message}`);
        loginError.classList.remove("hidden");
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));

    function toggleSidebar(force){ sidebar.classList.toggle('-translate-x-full', force ?? sidebar.classList.contains('-translate-x-full')===false); }
    btnMenu?.addEventListener('click', ()=> sidebar.classList.toggle('-translate-x-full'));

    let isAdmin=false, isStaff=false, allItems=[];
    onAuthStateChanged(auth, async (user) => {
      if (!user) { dashboard.classList.add("hidden"); loginScreen.classList.remove("hidden"); return; }
      try {
        const roleDoc = await getDoc(doc(db, 'roles', user.uid));
        const role = roleDoc.exists() ? (roleDoc.data().role || 'viewer') : 'viewer';
        isAdmin = role === "admin"; isStaff = role === "staff";
        roleLabelEl.textContent = role;
        userBadge.textContent = `${user.email || user.uid} (${role})`;

        if (!(isAdmin || isStaff)) {
          loginError.textContent = "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏ï‡∏±‡πâ‡∏á roles/{uid}.role ‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠ staff";
          loginError.classList.remove("hidden");
          dashboard.classList.add("hidden"); loginScreen.classList.remove("hidden"); return;
        }
        loginScreen.classList.add("hidden"); dashboard.classList.remove("hidden");
        setTab('list'); loadCustomers();
      } catch (e) { alert('‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); await signOut(auth); }
    });

    function setTab(t){
      const on=(el,yes)=>{ el.classList.toggle('tab-on', yes); el.classList.toggle('border-transparent', !yes); }
      pageList.classList.toggle('hidden', t!=='list'); pageReport.classList.toggle('hidden', t!=='report');
      on(tabList, t==='list'); on(tabReport, t==='report');
    }
    tabList.addEventListener('click', ()=>setTab('list'));
    tabReport.addEventListener('click', ()=>setTab('report'));
    sbListBtn.addEventListener('click', ()=>{ setTab('list'); toggleSidebar(true); });
    sbReportBtn.addEventListener('click', ()=>{ setTab('report'); toggleSidebar(true); });

    function loadCustomers(){
      const qy = query(collection(db,"customers"), orderBy("createdAt","desc"));
      onSnapshot(qy, (snap)=>{
        allItems = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        countAllEl.textContent = allItems.length;
        renderList(allItems);
        ensureDefaultDateRange(); applyFilters();
      });
    }

    function card(c){
      return `<div class="border border-slate-200 rounded-2xl shadow-sm p-4 hover:shadow transition bg-white">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-700 grid place-items-center font-bold">${(c.name||'?').substring(0,1)}</div>
            <div>
              <div class="font-semibold text-slate-900">${escapeHtml(c.name||'-')}</div>
              <div class="text-xs text-slate-500">${escapeHtml(c.phone||'-')}</div>
            </div>
          </div>
          <span class="text-xs bg-slate-100 text-slate-800 border border-slate-200 rounded-full px-2 py-0.5">${escapeHtml(c.decision||'-')}</span>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <div><span class="text-slate-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> ${fmtTH(c.date)}</div>
          <div><span class="text-slate-500">‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏:</span> ${escapeHtml(c.gender||'-')} / ${escapeHtml(c.age||'-')} ‡∏õ‡∏µ</div>
          <div><span class="text-slate-500">‡∏´‡πâ‡∏≠‡∏á:</span> ${escapeHtml(c.roomType||'-')}</div>
          <div><span class="text-slate-500">‡∏£‡∏≤‡∏Ñ‡∏≤:</span> ‡∏ø${fmtNum(c.price)}</div>
        </div>
        <div class="mt-3 text-xs text-slate-500 line-clamp-2"><b>‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©:</b> ${escapeHtml(c.specialCare||'-')}</div>
        <div class="mt-4 flex items-center justify-between">
          <button class="text-sky-700 hover:text-sky-900 underline" onclick="editStatus('${c.id}','${(c.decision||'').replace(/'/g,'&#39;')}')">‡πÅ‡∏Å‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
          ${isAdmin ? `<button class="text-rose-600 hover:text-rose-700 underline" onclick="deleteCustomer('${c.id}')">‡∏•‡∏ö</button>` : `<span class="text-slate-400 text-xs">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin ‡∏•‡∏ö‡πÑ‡∏î‡πâ</span>`}
        </div>
      </div>`;
    }
    function renderList(items){
      totalEl.textContent = items.length;
      cardListEl.innerHTML = items.length
        ? items.map(card).join('')
        : `<div class="p-10 text-center text-slate-500 w-full">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
    }

    searchBox.addEventListener('input', ()=> {
      const q = searchBox.value.trim().toLowerCase();
      const filtered = allItems.filter(c =>
        [c.name,c.phone,c.gender,c.roomType,c.decision].some(v => (v||'').toLowerCase().includes(q))
      );
      renderList(filtered);
    });

    window.deleteCustomer = async (id)=>{
      if (!isAdmin) return alert("‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö");
      if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db,"customers",id));
    };
    window.editStatus = (id, currentStatus)=>{
      const tpl = document.getElementById('statusModalTpl').content.cloneNode(true);
      const modal = tpl.querySelector('[class*="fixed"]');
      const select = tpl.querySelector('#modalStatus'); select.value = currentStatus || '‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à';
      tpl.querySelector('#okBtn').addEventListener('click', async ()=>{
        const newStatus = select.value;
        const ref = doc(db,'customers',id);
        if (newStatus === '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'){
          await updateDoc(ref, { decision: newStatus, closedAt: serverTimestamp() });
        } else {
          await updateDoc(ref, { decision: newStatus, closedAt: deleteField() });
        }
        document.body.removeChild(modal);
      });
      tpl.querySelector('#cancelBtn').addEventListener('click', ()=> document.body.removeChild(modal));
      document.body.appendChild(modal);
    };

    function ensureDefaultDateRange(){
      if (!fStart.value || !fEnd.value){
        const today = new Date();
        const start = new Date(); start.setDate(today.getDate() - 90);
        fStart.value = start.toISOString().slice(0,10);
        fEnd.value   = today.toISOString().slice(0,10);
      }
    }
    function applyFilters(){
      const min = fMin.value ? Number(fMin.value) : -Infinity;
      const max = fMax.value ? Number(fMax.value) : Infinity;
      const status = fStatus.value, room = fRoom.value, gender = fGender.value;
      const start = fStart.value ? new Date(fStart.value + 'T00:00:00') : null;
      const end   = fEnd.value   ? new Date(fEnd.value   + 'T23:59:59') : null;

      const filtered = allItems.filter(c=>{
        const dt = getDateFromDoc(c);
        if (start && dt && dt < start) return false;
        if (end && dt && dt > end) return false;
        if (status && (c.decision||'') !== status) return false;
        if (room && (c.roomType||'') !== room) return false;
        if (gender && (c.gender||'') !== gender) return false;
        const price = Number(c.price||0); if (price < min || price > max) return false;
        return true;
      });

      countAllEl.textContent = allItems.length;
      countFilteredEl.textContent = filtered.length;

      kAll.textContent = allItems.length;
      kPeriod.textContent = filtered.length;
      const won = filtered.filter(c=> (c.decision||'')==='‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à').length;
      kWon.textContent = won;
      kWinRate.textContent = filtered.length ? ( (won/filtered.length*100).toFixed(1)+'%' ) : '0%';
      const avg = filtered.length ? Math.round(filtered.reduce((a,c)=>a+Number(c.price||0),0)/filtered.length) : 0;
      kAvgPrice.textContent = '‡∏ø'+fmtNum(avg);
    }
    btnApply.addEventListener('click', applyFilters);
    btnReset.addEventListener('click', ()=>{ fStatus.value=''; fRoom.value=''; fGender.value=''; fMin.value=''; fMax.value=''; ensureDefaultDateRange(); applyFilters(); });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    setTab('list');
  </script>
</body>
</html>
