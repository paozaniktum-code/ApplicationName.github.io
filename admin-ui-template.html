<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script><!-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≤‡∏ü ‡πÅ‡∏Ñ‡πà‡∏Å‡∏±‡∏ô warning imports ‡∏ö‡∏≤‡∏á‡∏ò‡∏µ‡∏° -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    body{font-family:'Sarabun',sans-serif}
    .chip{background:#eef2ff;color:#3730a3;padding:.35rem .7rem;border-radius:9999px;font-size:.85rem}
    .pill{background:#e0f2fe;color:#0369a1;border-radius:9999px;padding:.45rem .8rem}
    .chip-warn{background:#fef3c7;color:#92400e}
    .btn{border-radius:.75rem;padding:.6rem 1rem;font-weight:600}
  </style>
</head>
<body class="bg-sky-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <h1 class="text-2xl font-bold flex items-center gap-2">üìö ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
      <p class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‚Üí ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å / ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Filter bar (‡πÑ‡∏°‡πà‡∏°‡∏µ sidebar) -->
    <section class="bg-white rounded-xl shadow p-4 mb-4">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-center">
        <div class="lg:col-span-5">
          <input id="qText" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏´‡πâ‡∏≠‡∏á/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                 class="w-full border rounded-lg px-4 py-2.5 focus:ring focus:ring-blue-200"/>
        </div>
        <div class="lg:col-span-2">
          <select id="qStatus" class="w-full border rounded-lg px-3 py-2.5">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option>‡πÉ‡∏´‡∏°‡πà</option><option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option><option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
            <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option><option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
            <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
          </select>
        </div>
        <div class="lg:col-span-2">
          <select id="qRoom" class="w-full border rounded-lg px-3 py-2.5">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
            <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 2 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 3 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 5 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
          </select>
        </div>
        <div class="lg:col-span-2">
          <select id="qGender" class="w-full border rounded-lg px-3 py-2.5">
            <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏û‡∏®</option><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option>
          </select>
        </div>
        <div class="lg:col-span-1 flex gap-2">
          <button id="btnApply" class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
        </div>
        <div class="lg:col-span-12 flex items-center justify-end gap-3 text-sm text-gray-600">
          <button id="btnClear" class="btn bg-gray-200 hover:bg-gray-300 text-gray-800">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
          <span class="ml-auto">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="allCount">0</b> ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: <b id="showCount">0</b></span>
        </div>
      </div>
    </section>

    <!-- Report columns + Export -->
    <section class="bg-white rounded-xl shadow p-4 mb-6">
      <div class="text-lg font-semibold mb-2">Report ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-[15px] mb-3">
        <label><input class="colChk" type="checkbox" value="date" checked> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <label><input class="colChk" type="checkbox" value="name" checked> ‡∏ä‡∏∑‡πà‡∏≠</label>
        <label><input class="colChk" type="checkbox" value="phone" checked> ‡πÄ‡∏ö‡∏≠‡∏£‡πå</label>
        <label><input class="colChk" type="checkbox" value="gender"> ‡πÄ‡∏û‡∏®</label>
        <label><input class="colChk" type="checkbox" value="age"> ‡∏≠‡∏≤‡∏¢‡∏∏</label>
        <label><input class="colChk" type="checkbox" value="price"> ‡∏£‡∏≤‡∏Ñ‡∏≤</label>
        <label><input class="colChk" type="checkbox" value="roomType" checked> ‡∏´‡πâ‡∏≠‡∏á</label>
        <label><input class="colChk" type="checkbox" value="decision" checked> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnCsv"  class="btn bg-emerald-500 hover:bg-emerald-600 text-white">‚¨áÔ∏è Export CSV</button>
        <button id="btnJson" class="btn bg-emerald-500 hover:bg-emerald-600 text-white">‚¨áÔ∏è Export JSON</button>
        <button id="btnXlsx" class="btn bg-emerald-500 hover:bg-emerald-600 text-white">‚¨áÔ∏è Export Excel</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡πä‡∏Å‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</p>
    </section>

    <!-- Results -->
    <section id="result" class="space-y-3"></section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      deleteDoc, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // --- Init ---
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // ------ Admin gate (‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin) ------
    let isAdmin = false;
    onAuthStateChanged(auth, async (user) => {
      if (!user) return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ
      try{
        const r = await getDoc(doc(db,'roles',user.uid));
        isAdmin = r.exists() && r.data().role === 'admin';
        renderList(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
      }catch(e){ console.warn('‡∏≠‡πà‡∏≤‡∏ô role ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', e); }
    });

    // ------ Refs ------
    const qText   = document.getElementById('qText');
    const qStatus = document.getElementById('qStatus');
    const qRoom   = document.getElementById('qRoom');
    const qGender = document.getElementById('qGender');
    const btnApply= document.getElementById('btnApply');
    const btnClear= document.getElementById('btnClear');
    const allCount= document.getElementById('allCount');
    const showCount= document.getElementById('showCount');
    const resultEl= document.getElementById('result');

    const fmtTH = s => { const d=new Date(s); return isNaN(d)?'-':d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}); };
    const fmtNum = n => new Intl.NumberFormat('th-TH').format(n||0);

    let allItems = [];
    let viewItems = [];

    // ------ Live data ------
    onSnapshot(query(collection(db,'customers'), orderBy('createdAt','desc')), snap=>{
      allItems = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      allCount.textContent = allItems.length;
      applyFilter();
    });

    // ------ Filter ------
    function applyFilter(){
      const kw = qText.value.trim().toLowerCase();
      const st = qStatus.value, rm = qRoom.value, gd = qGender.value;
      viewItems = allItems.filter(c=>{
        if (kw && !(
          (c.name||'').toLowerCase().includes(kw) ||
          (c.phone||'').toLowerCase().includes(kw) ||
          (c.decision||'').toLowerCase().includes(kw) ||
          (c.roomType||'').toLowerCase().includes(kw) ||
          (c.note||'').toLowerCase().includes(kw)
        )) return false;
        if (st && (c.decision||'') !== st) return false;
        if (rm && (c.roomType||'') !== rm) return false;
        if (gd && (c.gender||'') !== gd) return false;
        return true;
      });
      showCount.textContent = viewItems.length;
      renderList();
    }
    btnApply.onclick = applyFilter;
    btnClear.onclick = ()=>{ qText.value=''; qStatus.value=''; qRoom.value=''; qGender.value=''; applyFilter(); };

    // ------ Render ------
    function renderList(){
      if (!viewItems.length){
        resultEl.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
      }
      resultEl.innerHTML = viewItems.map(c=>`
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex justify-between items-start gap-3">
            <div>
              <div class="text-sm text-gray-500">${fmtTH(c.date)}</div>
              <div class="text-xl font-semibold">${c.name||'-'}</div>
              <div class="flex flex-wrap gap-2 mt-2">
                <a href="tel:${c.phone||''}" class="pill">üìû ${c.phone||'-'}</a>
                <span class="chip">‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏: ${c.gender||'-'} / ${c.age||'-'} ‡∏õ‡∏µ</span>
                <span class="chip">‡∏´‡πâ‡∏≠‡∏á: ${c.roomType||'-'}</span>
                <span class="chip">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${fmtNum(c.price)}</span>
                <span class="chip chip-warn">${c.decision||'-'}</span>
              </div>
            </div>
            ${isAdmin ? `<button class="btn bg-rose-500 hover:bg-rose-600 text-white" onclick="deleteCustomer('${c.id}')">üóëÔ∏è ‡∏•‡∏ö</button>` : ``}
          </div>
        </div>
      `).join('');
    }
    window.deleteCustomer = async (id)=>{
      if (!isAdmin) return alert('‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
      if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) await deleteDoc(doc(db,'customers',id));
    };

    // ------ Export helpers ------
    const pickCols = () => Array.from(document.querySelectorAll('.colChk:checked')).map(el=>el.value);
    const shape = (items, cols) => items.map(c=>{
      const row = {};
      cols.forEach(k=>{
        let v = c[k];
        if (k==='date') v = fmtTH(c.date);
        if (k==='price') v = Number(c.price||0);
        row[k] = (v ?? '');
      });
      return row;
    });

    document.getElementById('btnCsv').onclick = ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols = pickCols(), rows = shape(viewItems, cols);
      const csv = [cols.join(',')].concat(rows.map(r=>cols.map(k=>{
        const s = (r[k]??'').toString().replace(/"/g,'""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      }).join(','))).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = Object.assign(document.createElement('a'), {
        href: URL.createObjectURL(blob),
        download: `report-${new Date().toISOString().slice(0,10)}.csv`
      }); a.click();
    };

    document.getElementById('btnJson').onclick = ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols = pickCols(), rows = shape(viewItems, cols);
      const blob = new Blob([JSON.stringify(rows,null,2)],{type:'application/json'});
      const a = Object.assign(document.createElement('a'), {
        href: URL.createObjectURL(blob),
        download: `report-${new Date().toISOString().slice(0,10)}.json`
      }); a.click();
    };

    document.getElementById('btnXlsx').onclick = ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols = pickCols(), rows = shape(viewItems, cols);
      const ws = XLSX.utils.json_to_sheet(rows, {header: cols});
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Report');
      XLSX.writeFile(wb, `report-${new Date().toISOString().slice(0,10)}.xlsx`);
    };
  </script>
</body>
</html>
