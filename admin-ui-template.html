<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script><!-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≤‡∏ü ‡πÅ‡∏ï‡πà‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box}
    body{font-family:'Sarabun',sans-serif}
    .sidebar{background:linear-gradient(180deg,#e6f0ff 0%,#f3f7ff 100%)}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- ===== Login ===== -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-white rounded-2xl shadow p-6">
      <div class="flex items-center gap-2 mb-4">
        <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center">üîí</div>
        <h1 class="text-lg font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h1>
      </div>
      <form id="loginForm" class="space-y-3">
        <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full border rounded-lg px-3 py-2" required />
        <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full border rounded-lg px-3 py-2" required />
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg py-2.5">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
      <p id="loginError" class="hidden mt-3 text-sm text-red-600"></p>
    </div>
  </div>

  <!-- ===== App ===== -->
  <div id="app" class="hidden">
    <header class="bg-white border-b">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-2">
        <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center">üìä</div>
        <h1 class="text-lg md:text-xl font-bold">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-12 gap-6">
      <!-- Sidebar (‡πÇ‡∏ó‡∏ô‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô) -->
      <aside class="sidebar col-span-12 md:col-span-3 rounded-2xl shadow-sm p-4 flex flex-col">
        <div class="mb-2 text-gray-400 text-sm">‡πÄ‡∏°‡∏ô‡∏π</div>

        <button id="btnMenuList"
          class="w-full flex items-center gap-3 px-3 py-2 rounded-xl bg-white text-blue-700 shadow-sm border border-blue-100">
          <span>üìã</span><span class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
        </button>

        <div class="mt-6 text-sm text-gray-500">
          ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b id="roleLabel">-</b><br/>
          <span id="emailLabel" class="break-all"></span>
        </div>

        <div class="mt-auto pt-4">
          <button id="logoutBtn" class="w-full bg-rose-500 hover:bg-rose-600 text-white rounded-xl py-2.5 text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          <div class="mt-3 text-xs text-gray-400">¬© 2025 LEAD</div>
        </div>
      </aside>

      <!-- Main -->
      <main class="col-span-12 md:col-span-9">
        <!-- Filters -->
        <section class="bg-white rounded-2xl shadow p-5 mb-4">
          <div class="flex flex-col md:flex-row md:items-end md:gap-3">
            <div class="flex-1">
              <label class="text-xs text-gray-500">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏´‡πâ‡∏≠‡∏á</label>
              <input id="qText" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô suri, 093..., ‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à, ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß" />
            </div>
            <div>
              <label class="text-xs text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="qStatus" class="w-full md:w-48 border rounded-lg px-3 py-2">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option>‡πÉ‡∏´‡∏°‡πà</option><option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option><option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option><option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
                <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-500">‡∏´‡πâ‡∏≠‡∏á</label>
              <select id="qRoom" class="w-full md:w-48 border rounded-lg px-3 py-2">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 2 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 3 ‡∏ó‡πà‡∏≤‡∏ô</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 5 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-500">‡πÄ‡∏û‡∏®</label>
              <select id="qGender" class="w-full md:w-40 border rounded-lg px-3 py-2">
                <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏û‡∏®</option><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option>
              </select>
            </div>
          </div>
          <div class="mt-3 flex gap-2">
            <button id="btnApply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
            <button id="btnReset" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            <span class="ml-auto text-sm text-gray-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="countAll">0</b> ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: <b id="countFiltered">0</b></span>
          </div>
        </section>

        <!-- Report / Export -->
        <section class="bg-white rounded-2xl shadow p-5 mb-4">
          <div class="text-lg font-bold mb-2">Report ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-y-2 text-sm">
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="date" checked> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="name" checked> ‡∏ä‡∏∑‡πà‡∏≠</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="phone" checked> ‡πÄ‡∏ö‡∏≠‡∏£‡πå</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="roomType" checked> ‡∏´‡πâ‡∏≠‡∏á</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="gender"> ‡πÄ‡∏û‡∏®</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="age"> ‡∏≠‡∏≤‡∏¢‡∏∏</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="price"> ‡∏£‡∏≤‡∏Ñ‡∏≤</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="decision"> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="disease"> ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="colpick" value="specialCare"> ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
          </div>
          <div class="mt-3 flex gap-2">
            <button id="btnExportCsv"  class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm">‚¨áÔ∏è Export CSV</button>
            <button id="btnExportJson" class="bg-green-600   hover:bg-green-700   text-white px-4 py-2 rounded-lg text-sm">‚¨áÔ∏è Export JSON</button>
            <button id="btnExportXlsx" class="bg-teal-600    hover:bg-teal-700    text-white px-4 py-2 rounded-lg text-sm">‚¨áÔ∏è Export Excel</button>
          </div>
        </section>

        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
        <section id="cardsWrap" class="space-y-4"></section>
      </main>
    </div>
  </div>

  <!-- ===== Script (Firebase + Logic) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // Init
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // Refs
    const loginScreen = document.getElementById('loginScreen');
    const appWrap     = document.getElementById('app');
    const loginError  = document.getElementById('loginError');
    const roleLabel   = document.getElementById('roleLabel');
    const emailLabel  = document.getElementById('emailLabel');
    const cardsWrap   = document.getElementById('cardsWrap');

    const qText   = document.getElementById('qText');
    const qStatus = document.getElementById('qStatus');
    const qRoom   = document.getElementById('qRoom');
    const qGender = document.getElementById('qGender');
    const btnApply= document.getElementById('btnApply');
    const btnReset= document.getElementById('btnReset');

    const countAllEl      = document.getElementById('countAll');
    const countFilteredEl = document.getElementById('countFiltered');

    const btnExportCsv  = document.getElementById('btnExportCsv');
    const btnExportJson = document.getElementById('btnExportJson');
    const btnExportXlsx = document.getElementById('btnExportXlsx');

    const fmtTH  = s => { const d = new Date(s); return isNaN(d) ? '-' : d.toLocaleDateString('th-TH', {year:'numeric',month:'short',day:'numeric'}); };
    const fmtNum = n => new Intl.NumberFormat('th-TH').format(n || 0);

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      loginError.classList.add('hidden');
      try{
        await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
      }catch(err){
        loginError.textContent = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err.code);
        loginError.classList.remove('hidden');
      }
    });
    document.getElementById('logoutBtn').addEventListener('click', ()=> signOut(auth));

    // State
    let isAdmin=false, isStaff=false;
    let allItems=[], filtered=[];

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        appWrap.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        return;
      }
      try{
        const r = await getDoc(doc(db,'roles',user.uid));
        const role = r.exists() ? (r.data().role || 'viewer') : 'viewer';
        isAdmin = role==='admin'; isStaff = role==='staff';
        roleLabel.textContent = role;
        emailLabel.textContent = user.email || '';
        if(!(isAdmin||isStaff)){
          loginError.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠ staff)";
          loginError.classList.remove('hidden');
          await signOut(auth); return;
        }
      }catch(e){
        alert('‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message);
        await signOut(auth); return;
      }

      loginScreen.classList.add('hidden');
      appWrap.classList.remove('hidden');

      // Subscribe customers (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° createdAt)
      const qy = query(collection(db,'customers'), orderBy('createdAt','desc'));
      onSnapshot(qy, (snap)=>{
        allItems = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        countAllEl.textContent = allItems.length;
        applyFilters();
      });
    });

    // Filters
    function applyFilters(){
      const text = (qText.value||'').toLowerCase().trim();
      const st   = qStatus.value;
      const rm   = qRoom.value;
      const gd   = qGender.value;

      filtered = allItems.filter(c=>{
        const bag = [c.name,c.phone,c.decision,c.roomType,c.gender].map(v=> (v||'').toString().toLowerCase()).join(' ');
        if(text && !bag.includes(text)) return false;
        if(st && (c.decision||'') !== st)   return false;
        if(rm && (c.roomType||'') !== rm)   return false;
        if(gd && (c.gender||'')   !== gd)   return false;
        return true;
      });

      countFilteredEl.textContent = filtered.length;
      renderCards(filtered);
    }
    btnApply.addEventListener('click', applyFilters);
    btnReset.addEventListener('click', ()=>{ qText.value=''; qStatus.value=''; qRoom.value=''; qGender.value=''; applyFilters(); });

    // Render
    function renderCards(items){
      if(!items.length){
        cardsWrap.innerHTML = `<div class="bg-white rounded-2xl shadow p-10 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>`;
        return;
      }
      cardsWrap.innerHTML = items.map(c=>{
        const statusOptions = [
          '‡πÉ‡∏´‡∏°‡πà','‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ','‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à','‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå',
          '‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà','‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à','‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'
        ].map(s=>`<option ${ (c.decision||'')===s ? 'selected' : '' }>${s}</option>`).join('');

        const delBtn = isAdmin ? `<button onclick="deleteCustomer('${c.id}')" class="px-4 py-2 rounded-xl bg-rose-500 hover:bg-rose-600 text-white text-sm">‡∏•‡∏ö</button>` : '';

        return `
          <article class="bg-white rounded-2xl shadow p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xs text-gray-400 mb-1">${fmtTH(c.date)}</div>
                <h3 class="text-xl font-bold mb-3">${c.name ?? '-'}</h3>
                <div class="flex flex-wrap items-center gap-2">
                  <a href="tel:${c.phone||''}" class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm flex items-center gap-1">üìû ${c.phone ?? '-'}</a>
                  <span class="px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 text-sm">‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏: ${c.gender ?? '-'} / ${c.age ?? '-'} ‡∏õ‡∏µ</span>
                  <span class="px-3 py-1 rounded-full bg-violet-100 text-violet-700 text-sm">‡∏´‡πâ‡∏≠‡∏á: ${c.roomType ?? '-'}</span>
                  <span class="px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${fmtNum(c.price)}</span>
                  <select onchange="updateStatus('${c.id}', this.value)" class="px-3 py-1 rounded-full border text-sm">${statusOptions}</select>
                </div>
                ${(c.disease||c.specialCare)?`
                  <div class="mt-3 text-sm text-gray-600">
                    ${c.disease?`<div>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${c.disease}</div>`:''}
                    ${c.specialCare?`<div>‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©: ${c.specialCare}</div>`:''}
                  </div>`:''}
              </div>
              <div class="flex-shrink-0">${delBtn}</div>
            </div>
          </article>`;
      }).join('');
    }

    // Actions
    async function updateStatus(id,newStatus){
      try{ await updateDoc(doc(db,'customers',id), { decision:newStatus }); toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','ok'); }
      catch(e){ toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message,'err'); }
    }
    window.updateStatus = updateStatus;

    async function deleteCustomer(id){
      if(!isAdmin) return;
      if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')){
        try{ await deleteDoc(doc(db,'customers',id)); toast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','ok'); }
        catch(e){ toast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message,'err'); }
      }
    }
    window.deleteCustomer = deleteCustomer;

    // Toast
    const toastBox = document.createElement('div'); toastBox.className='fixed left-1/2 -translate-x-1/2 top-4 z-50 space-y-2'; document.body.appendChild(toastBox);
    function toast(msg,type='info'){ const bg= type==='ok'?'bg-emerald-600':type==='err'?'bg-rose-600':'bg-slate-800'; const el=document.createElement('div'); el.className=`${bg} text-white px-3 py-2 rounded-lg shadow text-sm`; el.textContent=msg; toastBox.appendChild(el); setTimeout(()=>el.remove(),1800); }

    // Export helpers
    function getPickedColumns(){
      const picks = Array.from(document.querySelectorAll('.colpick')).filter(i=>i.checked).map(i=>i.value);
      return picks.length ? picks : ['date','name','phone','roomType','decision'];
    }
    function filteredToRows(){
      const cols = getPickedColumns();
      const rows = filtered.map(c=>{
        const o={};
        cols.forEach(k=>{
          if(k==='date')        o['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] = fmtTH(c.date);
          else if(k==='name')   o['‡∏ä‡∏∑‡πà‡∏≠'] = c.name || '';
          else if(k==='phone')  o['‡πÄ‡∏ö‡∏≠‡∏£‡πå'] = c.phone || '';
          else if(k==='roomType') o['‡∏´‡πâ‡∏≠‡∏á'] = c.roomType || '';
          else if(k==='gender') o['‡πÄ‡∏û‡∏®'] = c.gender || '';
          else if(k==='age')    o['‡∏≠‡∏≤‡∏¢‡∏∏'] = c.age ?? '';
          else if(k==='price')  o['‡∏£‡∏≤‡∏Ñ‡∏≤'] = c.price ?? '';
          else if(k==='decision') o['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] = c.decision || '';
          else if(k==='disease')  o['‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] = c.disease || '';
          else if(k==='specialCare') o['‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©'] = c.specialCare || '';
        });
        return o;
      });
      return { cols, rows };
    }

    btnExportCsv.addEventListener('click', ()=>{
      const { rows } = filteredToRows();
      if(!rows.length) return toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å','err');
      const header = Object.keys(rows[0]);
      const toCell = s => { const v=(s??'').toString(); return /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v; };
      const csv = [header.join(','), ...rows.map(r=> header.map(h=>toCell(r[h])).join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`report-${new Date().toISOString().slice(0,10)}.csv`; a.click();
    });

    btnExportJson.addEventListener('click', ()=>{
      const { rows } = filteredToRows();
      if(!rows.length) return toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å','err');
      const blob=new Blob([JSON.stringify(rows,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`report-${new Date().toISOString().slice(0,10)}.json`; a.click();
    });

    btnExportXlsx.addEventListener('click', ()=>{
      const { rows } = filteredToRows();
      if(!rows.length) return toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å','err');
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Report');
      XLSX.writeFile(wb, `report-${new Date().toISOString().slice(0,10)}.xlsx`);
    });

    // Sidebar scroll to top
    document.getElementById('btnMenuList').addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
  </script>
</body>
</html>
