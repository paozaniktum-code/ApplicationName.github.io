<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>App Admin ‚Äî ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box} body{font-family:'Sarabun',sans-serif}
    .glass{background:rgba(255,255,255,.9);backdrop-filter:saturate(140%) blur(8px)}
    .tab-active{color:#0ea5e9;border-color:#0ea5e9}
  </style>
</head>
<body class="min-h-screen bg-sky-50">
  <!-- ===== Login Screen ===== -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-6">
    <div class="glass w-full max-w-sm rounded-2xl shadow-xl p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full bg-sky-500 text-white grid place-content-center text-lg">A</div>
        <div>
          <div class="text-sm text-slate-500">App Admin</div>
          <h1 class="text-xl font-bold text-slate-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h1>
        </div>
      </div>
      <form id="loginForm" class="space-y-3">
        <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full border rounded-lg px-3 py-2" required>
        <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full border rounded-lg px-3 py-2" required>
        <button class="w-full bg-sky-600 hover:bg-sky-700 text-white rounded-lg py-2.5">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
      <p id="loginError" class="hidden mt-3 text-sm text-red-600"></p>
    </div>
  </div>

  <!-- ===== App Shell ===== -->
  <div id="appShell" class="hidden min-h-screen">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside id="sidebar" class="w-68 sm:w-72 bg-white border-r">
        <div class="px-4 py-4 border-b flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-sky-500 text-white grid place-content-center text-lg">A</div>
          <div>
            <div class="text-xs text-slate-500">App Admin</div>
            <div class="font-semibold text-slate-800">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</div>
          </div>
        </div>

        <nav class="px-3 py-4 space-y-1">
          <div class="text-[11px] uppercase tracking-wide text-slate-400 px-2 mb-1">‡πÄ‡∏°‡∏ô‡∏π</div>
          <button id="navList"
                  class="w-full text-left px-3 py-2 rounded-lg hover:bg-sky-50 flex items-center gap-2">
            <span>üìÑ</span><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
          </button>
          <button id="navSearch"
                  class="w-full text-left px-3 py-2 rounded-lg hover:bg-sky-50 flex items-center gap-2">
            <span>üîé</span><span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡∏£‡∏∏‡∏õ</span>
          </button>
          <div class="mt-3 text-xs text-slate-500 px-3">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b id="roleLabel">-</b></div>
          <div class="px-3 text-xs text-slate-500 break-all" id="userBadge">-</div>
        </nav>

        <!-- footer area (logout moved here) -->
        <div class="mt-auto px-4 py-4 border-t">
          <button id="logoutBtn"
                  class="w-full text-sm bg-rose-500 hover:bg-rose-600 text-white px-3 py-2 rounded-lg">
            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
          <div class="text-[11px] text-slate-400 mt-2">¬© 2025 YourBrand</div>
        </div>
      </aside>

      <!-- Main -->
      <main class="flex-1">
        <!-- Top bar (no logout button here) -->
        <header class="glass sticky top-0 z-30 border-b">
          <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-6">
            <div class="text-slate-800 font-bold">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            <div class="flex items-center gap-4 text-sm">
              <button id="tabList" class="pb-2 border-b-2 border-transparent hover:text-sky-700">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
              <button id="tabSearch" class="pb-2 border-b-2 border-transparent hover:text-sky-700">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡∏£‡∏∏‡∏õ</button>
            </div>
          </div>
        </header>

        <section class="max-w-6xl mx-auto px-4 py-6 space-y-6">
          <!-- LIST -->
          <div id="pageList" class="bg-white shadow-sm rounded-xl p-5">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
              <div class="text-sm text-slate-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="total">0</b> ‡∏Ñ‡∏ô</div>
            </div>
            <div id="list" class="grid gap-3"></div>
            <div id="emptyList" class="text-center text-slate-400 py-10 hidden">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
          </div>

          <!-- SEARCH -->
          <div id="pageSearch" class="hidden bg-white shadow-sm rounded-xl p-5">
            <h2 class="text-lg font-bold text-slate-800 mb-3">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡∏£‡∏∏‡∏õ</h2>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
              <input id="qKeyword" class="border rounded-lg px-3 py-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏´‡πâ‡∏≠‡∏á">
              <select id="qGender" class="border rounded-lg px-3 py-2"><option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏û‡∏®</option><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option></select>
              <select id="qRoom" class="border rounded-lg px-3 py-2">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 2 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 3 ‡∏ó‡πà‡∏≤‡∏ô</option>
                <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 5 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
              </select>
              <select id="qStatus" class="border rounded-lg px-3 py-2">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option>‡πÉ‡∏´‡∏°‡πà</option><option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option><option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option><option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
                <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
              </select>
            </div>
            <div class="flex gap-2 mb-4">
              <button id="btnSearch" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              <button id="btnReset" class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 py-2 rounded-lg text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
            <div id="searchResult" class="grid gap-3"></div>
            <div id="emptySearch" class="text-center text-slate-400 py-8 hidden">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- ===== Modal: confirm delete ===== -->
  <template id="confirmTpl">
    <div class="fixed inset-0 bg-black/40 grid place-content-center z-50">
      <div class="bg-white rounded-xl p-5 w-[90vw] max-w-md shadow-xl">
        <h3 class="text-lg font-bold mb-2">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
        <p class="text-sm text-slate-600 mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</p>
        <div class="flex gap-2 justify-end">
          <button class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800" data-cancel>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="px-3 py-2 rounded-lg bg-rose-600 text-white" data-ok>‡∏•‡∏ö</button>
        </div>
      </div>
    </div>
  </template>

  <!-- ===== App Script ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, query, orderBy, doc, deleteDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // Init
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // Refs
    const loginScreen = document.getElementById('loginScreen');
    const appShell    = document.getElementById('appShell');
    const loginError  = document.getElementById('loginError');
    const roleLabel   = document.getElementById('roleLabel');
    const userBadge   = document.getElementById('userBadge');
    const totalEl     = document.getElementById('total');
    const listWrap    = document.getElementById('list');
    const emptyList   = document.getElementById('emptyList');
    const searchWrap  = document.getElementById('searchResult');
    const emptySearch = document.getElementById('emptySearch');

    // Tabs & Nav
    const pageList   = document.getElementById('pageList');
    const pageSearch = document.getElementById('pageSearch');
    const tabList    = document.getElementById('tabList');
    const tabSearch  = document.getElementById('tabSearch');
    document.getElementById('navList').onclick   = ()=>setTab('list');
    document.getElementById('navSearch').onclick = ()=>setTab('search');
    tabList.onclick   = ()=>setTab('list');
    tabSearch.onclick = ()=>setTab('search');
    function setTab(t){
      const act=(btn,active)=>btn.classList.toggle('tab-active',active);
      pageList.classList.toggle('hidden', t!=='list');  act(tabList, t==='list');
      pageSearch.classList.toggle('hidden', t!=='search'); act(tabSearch, t==='search');
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      loginError.classList.add('hidden'); loginError.textContent='';
      try{
        await signInWithEmailAndPassword(auth,
          document.getElementById('email').value,
          document.getElementById('password').value);
      }catch(err){
        const map={
          "auth/operation-not-allowed":"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î Email/Password ‡πÉ‡∏ô Authentication",
          "auth/invalid-email":"‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          "auth/user-not-found":"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
          "auth/wrong-password":"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          "auth/network-request-failed":"‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢/‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö file://"
        };
        loginError.textContent="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(map[err.code]||`${err.code} ‚Äî ${err.message}`);
        loginError.classList.remove('hidden');
      }
    });

    // Logout (moved to sidebar bottom)
    document.getElementById('logoutBtn').addEventListener('click', ()=>signOut(auth));

    // Auth state + role check
    let isAdmin=false;
    onAuthStateChanged(auth, async user=>{
      if(!user){ appShell.classList.add('hidden'); loginScreen.classList.remove('hidden'); return; }
      const r = await getDoc(doc(db,'roles',user.uid));
      const role = r.exists()? (r.data().role || 'viewer') : 'viewer';
      isAdmin = role==='admin';
      roleLabel.textContent = role;
      userBadge.textContent = user.email || user.uid;

      if(role!=='admin' && role!=='staff'){
        loginError.textContent = "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (role = admin|staff)"; loginError.classList.remove('hidden');
        await signOut(auth); return;
      }
      loginScreen.classList.add('hidden');
      appShell.classList.remove('hidden');
      setTab('list');
      subscribeCustomers();
    });

    // Data
    let allItems = [];
    function subscribeCustomers(){
      onSnapshot(query(collection(db,'customers'), orderBy('createdAt','desc')), snap=>{
        allItems = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderList(allItems);
      });
    }

    // Render list as clean cards (white, no table)
    const fmtTH = s=>{ const d=new Date(s); return isNaN(d)?'-':d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}) };
    const fmtNum = n=> new Intl.NumberFormat('th-TH').format(n||0);

    function card(c){
      return `<div class="border rounded-xl p-4 hover:bg-sky-50 transition">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-slate-900 font-semibold">${escapeHtml(c.name||'-')}</div>
            <div class="text-sm text-slate-500">${escapeHtml(c.phone||'-')}</div>
          </div>
          <div class="text-sm text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <b>${fmtTH(c.date)}</b></div>
        </div>
        <div class="mt-3 grid sm:grid-cols-2 lg:grid-cols-4 gap-2 text-sm">
          <div>‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏: <b>${escapeHtml(c.gender||'-')}/${c.age||'-'}</b></div>
          <div>‡∏´‡πâ‡∏≠‡∏á: <b>${escapeHtml(c.roomType||'-')}</b></div>
          <div>‡∏£‡∏≤‡∏Ñ‡∏≤: <b>‡∏ø${fmtNum(c.price)}</b></div>
          <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${escapeHtml(c.decision||'-')}</b></div>
        </div>
        ${isAdmin? `<div class="mt-3">
            <button class="text-rose-600 hover:underline text-sm" onclick="delItem('${c.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
          </div>`:''}
      </div>`;
    }
    function renderList(arr){
      totalEl.textContent = arr.length;
      if(!arr.length){ listWrap.innerHTML=''; emptyList.classList.remove('hidden'); return; }
      emptyList.classList.add('hidden');
      listWrap.innerHTML = arr.map(card).join('');
    }

    // Delete (admin only)
    window.delItem = (id)=>{
      if(!isAdmin) return alert('‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin');
      const tpl = document.getElementById('confirmTpl').content.cloneNode(true);
      const root = tpl.querySelector('div[data-root]')||tpl.children[0];
      tpl.querySelector('[data-cancel]').onclick=()=>document.body.removeChild(root);
      tpl.querySelector('[data-ok]').onclick=async()=>{ await deleteDoc(doc(db,'customers',id)); document.body.removeChild(root); };
      document.body.appendChild(root);
    };

    // Search / summary (client-side)
    const qKeyword=document.getElementById('qKeyword');
    const qGender=document.getElementById('qGender');
    const qRoom  =document.getElementById('qRoom');
    const qStatus=document.getElementById('qStatus');
    document.getElementById('btnSearch').onclick = ()=>{
      const k=(qKeyword.value||'').trim().toLowerCase();
      const arr = allItems.filter(c=>{
        const okK = !k || [c.name,c.phone,c.decision,c.roomType].some(v=>(v||'').toLowerCase().includes(k));
        const okG = !qGender.value || (c.gender===qGender.value);
        const okR = !qRoom.value   || (c.roomType===qRoom.value);
        const okS = !qStatus.value || (c.decision===qStatus.value);
        return okK && okG && okR && okS;
      });
      renderSearch(arr);
    };
    document.getElementById('btnReset').onclick=()=>{
      qKeyword.value=''; qGender.value=''; qRoom.value=''; qStatus.value='';
      renderSearch(allItems);
    };
    function renderSearch(arr){
      if(!arr.length){ searchWrap.innerHTML=''; emptySearch.classList.remove('hidden'); return; }
      emptySearch.classList.add('hidden');
      searchWrap.innerHTML = arr.map(card).join('');
    }

    // Utils
    const escapeHtml = s => (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  </script>
</body>
</html>
