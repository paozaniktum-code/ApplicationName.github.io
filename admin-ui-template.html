<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    body{font-family:'Sarabun',sans-serif}
    .menu-active{background:#e0f2fe;color:#2563eb;font-weight:700}
    .chip{background:#eef2ff;color:#3730a3;padding:.25rem .6rem;border-radius:9999px;font-size:.82rem}
  </style>
</head>
<body class="bg-sky-50 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-white border-r flex flex-col">
    <div class="p-4 border-b">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold">A</div>
        <h1 class="text-lg font-bold text-blue-700">App Admin</h1>
      </div>
    </div>
    <nav class="flex-1 p-4 space-y-2">
      <div class="text-xs text-gray-400 mb-1">‡πÄ‡∏°‡∏ô‡∏π</div>
      <a href="#" id="btnList" class="block px-3 py-2 rounded hover:bg-blue-100">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
      <button id="btnReport" class="w-full text-left px-3 py-2 rounded hover:bg-blue-100 menu-active">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡∏£‡∏∏‡∏õ</button>
    </nav>
    <div class="mt-auto p-4 border-t">
      <div class="text-sm"><span class="text-gray-500">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</span> <b id="roleBadge">-</b></div>
      <div id="emailBadge" class="text-xs text-gray-500 truncate"></div>
    </div>
    <div class="p-4 pt-2">
      <button id="logoutBtn" class="w-full bg-rose-500 hover:bg-rose-600 text-white text-sm font-semibold px-3 py-2 rounded-lg">
        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
      <div class="text-xs text-gray-400 mt-3">¬© 2025 YourBrand</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-6">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2 mb-4">
      üìö ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    </h2>

    <!-- ‡πÅ‡∏ñ‡∏ö Breadcrumb ‡πÄ‡∏•‡πá‡∏Å‡πÜ -->
    <div class="text-sm text-gray-500 mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô Report ‚Üí Export</div>

    <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° -->
    <div class="bg-white rounded-xl shadow p-4 mb-4">
      <div class="flex items-center gap-3">
        <input id="qText" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏´‡πâ‡∏≠‡∏á/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
               class="flex-1 border rounded-lg px-4 py-2.5 focus:ring focus:ring-blue-200"/>
        <select id="qStatus" class="border rounded-lg px-3 py-2.5">
          <option value="">‡πÉ‡∏´‡∏°‡πà</option>
          <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
        <button id="btnApply" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
        <button id="btnClear" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2.5 rounded-lg">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
      </div>
    </div>

    <!-- Report: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå + Export -->
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <div class="text-lg font-semibold mb-3">Report ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 text-[15px]">
        <label><input class="colChk" type="checkbox" value="date" checked> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <label><input class="colChk" type="checkbox" value="name" checked> ‡∏ä‡∏∑‡πà‡∏≠</label>
        <label><input class="colChk" type="checkbox" value="phone" checked> ‡πÄ‡∏ö‡∏≠‡∏£‡πå</label>
        <label><input class="colChk" type="checkbox" value="roomType" checked> ‡∏´‡πâ‡∏≠‡∏á</label>
        <label><input class="colChk" type="checkbox" value="gender"> ‡πÄ‡∏û‡∏®</label>
        <label><input class="colChk" type="checkbox" value="age"> ‡∏≠‡∏≤‡∏¢‡∏∏</label>
        <label><input class="colChk" type="checkbox" value="price"> ‡∏£‡∏≤‡∏Ñ‡∏≤</label>
        <label><input class="colChk" type="checkbox" value="decision"> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="exportCsv" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2.5 rounded-lg">‚¨áÔ∏è Export CSV</button>
        <button id="exportJson" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2.5 rounded-lg">‚¨áÔ∏è Export JSON</button>
        <button id="exportXlsx" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2.5 rounded-lg">‚¨áÔ∏è Export Excel</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</p>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
    <div id="result" class="space-y-3"></div>
  </main>

  <!-- Firebase & App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // UI refs
    const roleBadge = document.getElementById('roleBadge');
    const emailBadge = document.getElementById('emailBadge');
    const qText = document.getElementById('qText');
    const qStatus = document.getElementById('qStatus');
    const btnApply = document.getElementById('btnApply');
    const btnClear = document.getElementById('btnClear');
    const resultEl = document.getElementById('result');

    const exportCsvBtn = document.getElementById('exportCsv');
    const exportJsonBtn = document.getElementById('exportJson');
    const exportXlsxBtn = document.getElementById('exportXlsx');

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', ()=> signOut(auth));

    // state
    let allItems = [];
    let viewItems = [];
    let isAdmin = false;

    // auth
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='index.html'; return; }
      emailBadge.textContent = user.email || user.uid;

      try{
        const token = await getIdTokenResult(user, true);
        const role = token.claims.role || 'viewer';
        roleBadge.textContent = role;
        isAdmin = role === 'admin';
      }catch(e){ roleBadge.textContent='viewer'; }

      startRealtime();
    });

    // fetch realtime
    function startRealtime(){
      const qy = query(collection(db,'customers'), orderBy('createdAt','desc'));
      onSnapshot(qy, (snap)=>{
        allItems = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        applyFilter();
      });
    }

    // helpers
    const fmtTH = s => { const d=new Date(s); return isNaN(d)?'-':d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}) };
    const fmtNum = n => new Intl.NumberFormat('th-TH').format(n||0);

    function matchesKeyword(c, kw){
      if(!kw) return true;
      kw = kw.toLowerCase();
      const hay = [
        c.name, c.phone, c.gender, c.roomType, c.decision, String(c.age), String(c.price)
      ].map(v=>(v??'').toString().toLowerCase()).join(' ');
      return hay.includes(kw);
    }

    // filter UI behaviour like the old one
    function applyFilter(){
      const kw = qText.value.trim();
      const mode = qStatus.value; // "" = ‡πÉ‡∏´‡∏°‡πà, "all" = ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      viewItems = allItems.filter(c=>{
        const okKw = matchesKeyword(c, kw);
        const okStatus = mode === 'all' ? true : ((c.decision||'') === '‡πÉ‡∏´‡∏°‡πà');
        return okKw && okStatus;
      });
      renderList();
    }

    function clearFilter(){
      qText.value = '';
      qStatus.value = '';
      applyFilter();
    }

    btnApply.addEventListener('click', applyFilter);
    btnClear.addEventListener('click', clearFilter);
    qText.addEventListener('keydown', e=>{ if(e.key==='Enter') applyFilter(); });

    // render
    function renderList(){
      if(!viewItems.length){
        resultEl.innerHTML = `<div class="text-gray-500 bg-white rounded-xl shadow p-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
      }
      resultEl.innerHTML = viewItems.map(c=>{
        return `
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-sm text-gray-500 mb-1">${fmtTH(c.date)} ‚Ä¢ <span class="chip">${c.roomType||'-'}</span></div>
              <div class="text-xl font-semibold truncate">${c.name||'-'}</div>
              <div class="text-gray-600 mt-1 flex flex-wrap gap-2 items-center">
                <a href="tel:${c.phone||''}" class="text-blue-600 hover:underline flex items-center gap-1">
                  üìû <span>${c.phone||'-'}</span>
                </a>
                <span class="chip">‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏: ${c.gender||'-'} / ${c.age||'-'} ‡∏õ‡∏µ</span>
                <span class="chip">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${fmtNum(c.price)}</span>
                <span class="chip bg-amber-100 text-amber-900">${c.decision||'-'}</span>
              </div>
            </div>
            <div class="shrink-0">
              ${isAdmin ? `<button class="bg-rose-500 hover:bg-rose-600 text-white px-3 py-2 rounded-lg" onclick="deleteCustomer('${c.id}')">‡∏•‡∏ö</button>` : ``}
            </div>
          </div>
        </div>`;
      }).join('');
    }

    // delete (admin only)
    window.deleteCustomer = async (id)=>{
      if(!isAdmin) return alert('‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
      if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) await deleteDoc(doc(db,'customers',id));
    };

    // Export
    const getSelectedCols = ()=> Array.from(document.querySelectorAll('.colChk:checked')).map(x=>x.value);
    const mapRow = (c, cols)=> cols.map(k=>{
      if(k==='date') return fmtTH(c.date);
      return (c[k] ?? '');
    });

    function download(filename, blob){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    }

    exportCsvBtn.addEventListener('click', ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols = getSelectedCols();
      const header = cols.join(',');
      const rows = viewItems.map(c=> mapRow(c, cols).map(v=>{
        v = (v??'').toString();
        return /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
      }).join(',')).join('\n');
      const csv = header + '\n' + rows;
      download(`report-${new Date().toISOString().slice(0,10)}.csv`, new Blob([csv],{type:'text/csv;charset=utf-8;'}));
    });

    exportJsonBtn.addEventListener('click', ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols = getSelectedCols();
      const arr = viewItems.map(c=>{
        const o={}; cols.forEach(k=>{ o[k] = (k==='date'? fmtTH(c.date) : c[k] ?? ''); }); return o;
      });
      download(`report-${new Date().toISOString().slice(0,10)}.json`, new Blob([JSON.stringify(arr,null,2)],{type:'application/json'}));
    });

    // Excel (XLSX ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‚Äì ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô HTML table ‡πÉ‡∏™‡πà MIME Excel)
    exportXlsxBtn.addEventListener('click', ()=>{
      if(!viewItems.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      const cols = getSelectedCols();
      const th = cols.map(c=>`<th style="border:1px solid #ccc;padding:6px;text-align:left">${c}</th>`).join('');
      const trs = viewItems.map(c=>{
        const tds = mapRow(c, cols).map(v=>`<td style="border:1px solid #ccc;padding:6px">${(v??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;')}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      const html = `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
      download(`report-${new Date().toISOString().slice(0,10)}.xls`, new Blob([html],{type:'application/vnd.ms-excel'}));
    });
  </script>
</body>
</html>
