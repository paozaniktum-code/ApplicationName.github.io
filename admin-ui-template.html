<!-- admin-report.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box} body{font-family:'Sarabun',sans-serif}
  </style>
</head>
<body class="bg-blue-50 min-h-screen flex">

  <!-- ===== Sidebar ===== -->
  <aside class="w-72 bg-white border-r flex flex-col">
    <div class="p-5 border-b">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-700 grid place-items-center font-bold">A</div>
        <div>
          <h1 class="text-lg font-bold text-blue-700">App Admin</h1>
          <div id="roleBadge" class="text-xs text-gray-500">role: -</div>
        </div>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-1">
      <div class="text-xs text-gray-400 mb-2">‡πÄ‡∏°‡∏ô‡∏π</div>
      <button id="menuList" class="w-full text-left px-3 py-2 rounded-lg bg-blue-50 text-blue-700 font-semibold">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      <button id="menuSearch" class="w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 text-gray-700">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏™‡∏£‡∏∏‡∏õ</button>

      <div class="mt-5 text-sm">
        <div class="text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b id="userEmail">-</b></div>
      </div>
    </nav>

    <div class="p-4 border-t">
      <button id="logoutBtn" class="w-full bg-rose-500 hover:bg-rose-600 text-white text-sm font-semibold px-3 py-2 rounded-lg">
        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
      <div class="mt-3 text-xs text-gray-400">¬© 2025 YourBrand</div>
    </div>
  </aside>

  <!-- ===== Main ===== -->
  <main class="flex-1 p-6">
    <!-- Top -->
    <div class="mb-4">
      <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
        <span>üìä</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      </h2>
      <p class="text-gray-600">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</p>
    </div>

    <!-- Search / Filters -->
    <section class="bg-white rounded-xl shadow p-4 mb-4">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
        <input id="qText" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
               class="border rounded-lg px-3 py-2 w-full">
        <select id="fStatus" class="border rounded-lg px-3 py-2 w-full">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
          <option>‡πÉ‡∏´‡∏°‡πà</option><option>‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</option><option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
          <option>‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏£‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option><option>‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
          <option>‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</option><option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option><option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
        </select>
        <select id="fRoom" class="border rounded-lg px-3 py-2 w-full">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
          <option>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
          <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 2 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 3 ‡∏ó‡πà‡∏≤‡∏ô</option>
          <option>‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° 5 ‡∏ó‡πà‡∏≤‡∏ô</option><option>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
        </select>
        <select id="fGender" class="border rounded-lg px-3 py-2 w-full">
          <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏û‡∏®</option><option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option>
        </select>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <button id="btnApply" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
        <button id="btnReset" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
        <span class="ml-auto text-sm text-gray-600">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="countAll">0</b> ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: <b id="countShown">0</b></span>
      </div>
    </section>

    <!-- List -->
    <section id="listWrap" class="space-y-3">
      <!-- rows append here -->
    </section>
  </main>

  <!-- ===== Scripts ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // Refs
    const countAllEl   = document.getElementById('countAll');
    const countShownEl = document.getElementById('countShown');
    const userEmailEl  = document.getElementById('userEmail');
    const roleBadgeEl  = document.getElementById('roleBadge');
    const listWrap     = document.getElementById('listWrap');

    const qText   = document.getElementById('qText');
    const fStatus = document.getElementById('fStatus');
    const fRoom   = document.getElementById('fRoom');
    const fGender = document.getElementById('fGender');

    document.getElementById('btnApply').addEventListener('click', applyFilters);
    document.getElementById('btnReset').addEventListener('click', ()=>{
      qText.value=''; fStatus.value=''; fRoom.value=''; fGender.value='';
      applyFilters();
    });
    document.getElementById('logoutBtn').addEventListener('click', ()=> signOut(auth).then(()=>location.href='index.html'));

    // State
    let isAdmin=false, isStaff=false;
    let rawItems = [];
    let shownItems = [];

    const fmtDateTH=(s)=>{ const d=new Date(s); return isNaN(d)?'-':d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}); };
    const fmtNum=(n)=> new Intl.NumberFormat('th-TH').format(n||0);

    // Auth flow
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login ‡πÅ‡∏¢‡∏Å, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô location.href
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ signIn ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏±‡∏Å‡∏ä‡∏±‡∏ô)
        // await signInWithEmailAndPassword(auth, "admin@example.com", "yourPass");
        alert('‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô'); location.href='index.html'; return;
      }
      userEmailEl.textContent = user.email || user.uid;

      // ‡∏≠‡πà‡∏≤‡∏ô role
      const r = await getDoc(doc(db,'roles',user.uid));
      const role = r.exists()? (r.data().role || 'viewer') : 'viewer';
      isAdmin = role==='admin';
      isStaff = role==='staff';
      roleBadgeEl.textContent = 'role: ' + role;

      if(!(isAdmin||isStaff)){
        alert('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠ staff)'); await signOut(auth); location.href='index.html'; return;
      }

      // subscribe customers
      const qy = query(collection(db,'customers'), orderBy('createdAt','desc'));
      onSnapshot(qy, snap=>{
        rawItems = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        countAllEl.textContent = rawItems.length;
        applyFilters();
      }, err=>{
        console.error(err);
        alert('‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message||err.code));
      });
    });

    function applyFilters(){
      const kw = qText.value.trim().toLowerCase();
      shownItems = rawItems.filter(c=>{
        if (fStatus.value && (c.decision||'') !== fStatus.value) return false;
        if (fRoom.value   && (c.roomType||'') !== fRoom.value)   return false;
        if (fGender.value && (c.gender||'')   !== fGender.value) return false;
        if (kw){
          const hay = [
            c.name, c.phone, c.decision, c.roomType, c.disease, c.specialCare
          ].map(x=>(x||'').toString().toLowerCase()).join(' ');
          if (!hay.includes(kw)) return false;
        }
        return true;
      });
      countShownEl.textContent = shownItems.length;
      renderList(shownItems);
    }

    function renderList(items){
      if (!items.length){
        listWrap.innerHTML = `
          <div class="bg-white rounded-xl shadow p-8 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        `;
        return;
      }
      listWrap.innerHTML = items.map((c,i)=>`
        <article class="bg-white rounded-xl shadow p-4">
          <div class="flex flex-wrap items-center gap-3 justify-between">
            <div class="flex-1 min-w-[220px]">
              <div class="text-sm text-gray-500">${fmtDateTH(c.date)}</div>
              <div class="text-lg font-semibold text-gray-800">${escapeHTML(c.name||'-')}</div>
              <div class="text-sm text-gray-600">‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${escapeHTML(c.phone||'-')}</div>
            </div>
            <div class="min-w-[200px] text-sm text-gray-700">
              <div>‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏: ${escapeHTML(c.gender||'-')} / ${c.age??'-'} ‡∏õ‡∏µ</div>
              <div>‡∏´‡πâ‡∏≠‡∏á: ${escapeHTML(c.roomType||'-')}</div>
              <div>‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${fmtNum(c.price||0)}</div>
              <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${escapeHTML(c.decision||'-')}</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50" onclick="viewDetail('${c.id}')">üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              ${isAdmin? `<button class="px-3 py-2 text-sm rounded-lg bg-rose-500 text-white hover:bg-rose-600" onclick="removeItem('${c.id}')">üóëÔ∏è ‡∏•‡∏ö</button>`:''}
            </div>
          </div>
        </article>
      `).join('');
    }

    // actions for buttons (expose to window)
    window.viewDetail = (id)=>{
      const c = shownItems.find(x=>x.id===id) || rawItems.find(x=>x.id===id);
      if(!c) return;
      const txt = [
        `üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤`,
        `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fmtDateTH(c.date)}`,
        `‡∏ä‡∏∑‡πà‡∏≠: ${c.name||'-'}`,
        `‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${c.phone||'-'}`,
        `‡πÄ‡∏û‡∏®/‡∏≠‡∏≤‡∏¢‡∏∏: ${c.gender||'-'} / ${c.age??'-'} ‡∏õ‡∏µ`,
        `‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${c.disease||'-'}`,
        `‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©: ${c.specialCare||'-'}`,
        `‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à: ${c.roomType||'-'}`,
        `‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${fmtNum(c.price||0)}`,
        `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${c.decision||'-'}`
      ].join('\n');
      alert(txt);
    };

    window.removeItem = async (id)=>{
      if(!isAdmin) return alert('‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin');
      if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')){
        await deleteDoc(doc(db,'customers',id));
      }
    };

    function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  </script>
</body>
</html>
